<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
/* Base layout */
:root{
  --green:#12b886;
  --green-dark:#0f9a72;
  --bg-grad-1:#eafaf1;
  --bg-grad-2:#d7f2e4;
  --text:#122;
  --muted:#5b6b6b;
  --card:#ffffffcc;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg,var(--bg-grad-1), var(--bg-grad-2));
  color:var(--text);
  direction:rtl;
  display:flex;
  flex-direction:column;
}

/* Header */
header{
  background:var(--green);
  color:#fff;
  padding:16px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.brand{
  display:flex; align-items:center; gap:10px; font-weight:bold; font-size:20px;
}
.header-actions{display:flex; gap:8px}
header button{
  border:none; background:#fff; color:var(--green);
  border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600;
}
header button:hover{background:#f3fef8}

/* Main layout */
.main{
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:16px;
  padding:16px;
  flex:1;
}
@media (max-width: 960px){
  .main{grid-template-columns: 1fr}
}

/* Cards & panels */
.card{
  background:var(--card);
  backdrop-filter:blur(10px);
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  padding:16px;
  transition:transform .25s ease, opacity .25s ease;
}
.card h3{margin:0 0 10px 0}
.muted{color:var(--muted); font-size:14px}

button.primary{
  width:100%; padding:12px; border:none; border-radius:10px;
  background:var(--green); color:#fff; font-size:16px; cursor:pointer;
  transition:transform .2s ease, background .2s ease;
}
button.primary:hover{background:var(--green-dark); transform:scale(1.02)}

button.ghost{
  width:100%; padding:12px; border:2px solid var(--green);
  border-radius:10px; color:var(--green); background:transparent; cursor:pointer;
}

/* Inputs */
.input{
  display:flex; flex-direction:column; gap:6px; margin-bottom:10px;
}
.input label{font-size:14px; color:#244}
.input input, .input select, .input textarea{
  padding:10px; border:1px solid #cfd8d8; border-radius:10px; font-size:15px; background:#fff;
}
.row{display:flex; gap:10px}
.row > *{flex:1}

/* Map */
#map{
  width:100%; height:100%; min-height:420px;
  border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,0.08);
}

/* Modal / Welcome */
.modal{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.25); z-index:1000; padding:16px;
}
.modal .window{
  max-width:720px; width:100%;
  background:var(--card); backdrop-filter:blur(12px);
  border-radius:16px; padding:22px;
  box-shadow:0 10px 28px rgba(0,0,0,0.15);
  animation:pop .25s ease;
}
@keyframes pop{from{transform:scale(.98); opacity:0} to{transform:scale(1); opacity:1}}
.actions{display:flex; gap:10px; margin-top:12px}

/* Offer list */
.offer{
  border:1px solid #e5efef; border-radius:12px; padding:12px; margin-bottom:10px; background:#fff;
}
.offer-header{display:flex; justify-content:space-between; align-items:center}
.badge{background:#effaf5; color:var(--green-dark); padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
.tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
.tag{background:#f2fbf7; color:#285; padding:4px 8px; border-radius:999px; font-size:12px}
.offer-actions{display:flex; gap:8px; margin-top:10px}
button.sm{padding:8px 10px; border:none; border-radius:8px; cursor:pointer}
button.accept{background:var(--green); color:#fff}
button.reject{background:#f44336; color:#fff}

/* Chat */
.chat{border:1px solid #e5efef; border-radius:12px; padding:10px; background:#fff; max-height:220px; overflow:auto}
.chat-msg{margin-bottom:8px}
.chat-meta{font-size:12px; color:#666}

/* Hidden util */
.hidden{display:none}
.success{color:#1b8a5a}
.error{color:#c62828}

/* Image preview */
.preview{display:flex; gap:8px; flex-wrap:wrap}
.preview img{width:84px; height:84px; object-fit:cover; border-radius:10px; border:1px solid #e5efef}
</style>
</head>
<body>

<header>
  <div class="brand">ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</div>
  <div class="header-actions">
    <button id="btnRoleCustomer" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
    <button id="btnRoleDriver" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
    <button id="btnLogout" class="hidden">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<div class="main">
  <!-- Left column: Controls -->
  <div class="card" id="panelControls">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <p class="muted">Ø§Ø®ØªØ± Ø¯ÙˆØ±ÙƒØŒ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ ÙˆØ§Ù†Ø´Ø± Ø£Ùˆ Ø§Ø­Ø¬Ø² Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>

    <!-- Role selection -->
    <div id="roleSelect" class="actions">
      <button class="primary" onclick="openLogin('customer')">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†</button>
      <button class="ghost" onclick="openLogin('driver')">Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>

    <!-- Driver setup -->
    <div id="driverSetup" class="hidden">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>
      <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="drvName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯"/></div>
      <div class="row">
        <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø£Ø±Ø¯Ù†)</label><input id="drvPhone" placeholder="+9627XXXXXXXX"/></div>
        <div class="input"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="drvAge" type="number" min="18" placeholder="Ø§Ù„Ø¹Ù…Ø±"/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="drvGender"><option>Ø°ÙƒØ±</option><option>Ø£Ù†Ø«Ù‰</option></select>
        </div>
        <div class="input"><label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label><input id="drvRating" type="number" step="0.1" min="0" max="5" placeholder="4.8"/></div>
      </div>

      <div class="row">
        <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©"/></div>
        <div class="input"><label>Ù„ÙˆÙ† Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carColor" placeholder="Ø£Ø¨ÙŠØ¶ØŒ Ø£Ø³ÙˆØ¯..."/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carBrand" placeholder="ØªÙˆÙŠÙˆØªØ§ØŒ Ù‡ÙˆÙ†Ø¯Ø§..."/></div>
        <div class="input"><label>Ù†ÙˆØ¹/Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carModel" placeholder="ÙƒÙˆØ±ÙˆÙ„Ø§ØŒ Ø³ÙŠÙÙŠÙƒ..."/></div>
      </div>

      <div class="input">
        <label>ØµÙˆØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <input id="carPhotos" type="file" multiple accept="image/*"/>
        <div id="photoPreview" class="preview"></div>
      </div>

      <div class="input">
        <label><input type="checkbox" id="shareLocConsent"/> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</label>
      </div>

      <button class="primary" onclick="saveDriverProfile()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
      <p id="drvSaveStatus" class="muted"></p>

      <hr/>

      <h3>Ù†Ø´Ø± Ø¹Ø±Ø¶ Ø±Ø­Ù„Ø©</h3>
      <div class="row">
        <div class="input"><label>Ù…Ù†</label><select id="fromRegion"></select></div>
        <div class="input"><label>Ø¥Ù„Ù‰</label><select id="toRegion"></select></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙŠÙ†Ø§Ø±)</label><input id="offerPrice" type="number" min="0" step="0.5"/></div>
        <div class="input"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯</label><input id="offerSeats" type="number" min="1"/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label><input id="offerTime" type="datetime-local"/></div>
        <div class="input"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="offerNotes" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"/></div>
      </div>

      <button class="primary" onclick="publishOffer()">Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶</button>
      <p id="offerStatus" class="muted"></p>

      <hr/>

      <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h3>
      <div id="driverRequests"></div>
    </div>

    <!-- Customer view -->
    <div id="customerView" class="hidden">
      <h3>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
      <div class="row">
        <div class="input"><label>Ù…Ù†</label><select id="filterFrom"></select></div>
        <div class="input"><label>Ø¥Ù„Ù‰</label><select id="filterTo"></select></div>
      </div>
      <button class="primary" onclick="applyFilters()">ØªØµÙÙŠØ©</button>
      <button class="ghost" onclick="clearFilters()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØµÙÙŠØ©</button>

      <div id="offersList" style="margin-top:10px;"></div>

      <hr/>
      <h3>Ø­Ø¬Ø² Ù„Ø§Ø­Ù‚ (Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¯Ø¯)</h3>
      <div class="row">
        <div class="input"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label><input id="lateSeats" type="number" min="1" value="1"/></div>
        <div class="input"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="lateNote" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù‚ÙŠØ¨Ø© ÙƒØ¨ÙŠØ±Ø©"/></div>
      </div>
      <p class="muted">Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· "Ø­Ø¬Ø²" Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ.</p>
    </div>
  </div>

  <!-- Right column: Map & chat -->
  <div class="card">
    <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­ÙŠØ©</h3>
    <p class="muted">ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…ÙˆØ§Ù‚Ø¹Ùƒ ÙˆÙ…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª. ÙŠØ³Ù…Ø­ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ø¨Ø¹Ø¯ Ù…Ù† Ù¦ ÙƒÙ….</p>
    <div id="map"></div>

    <hr/>
    <h3>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h3>
    <div id="chatBox" class="chat"></div>
    <div class="row">
      <input id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©..."/>
      <button class="primary" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<!-- Welcome modal -->
<div class="modal" id="welcomeModal">
  <div class="window">
    <h2 style="margin-top:0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <span style="color:var(--green)">ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</span></h2>
    <p id="welcomeQuote" class="muted" style="font-size:16px;"></p>
    <div class="actions">
      <button class="primary" onclick="openLogin('customer')">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†</button>
      <button class="ghost" onclick="openLogin('driver')">Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>
  </div>
</div>

<!-- Login modal -->
<div class="modal hidden" id="loginModal">
  <div class="window">
    <h3 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <div class="row">
      <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="loginName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ"/></div>
      <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø£Ø±Ø¯Ù†)</label><input id="loginPhone" placeholder="+9627XXXXXXXX"/></div>
    </div>
    <div class="input"><label><input type="checkbox" id="loginConsent"/> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</label></div>
    <div class="row">
      <button class="primary" onclick="sendVerification()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</button>
      <div class="input" style="flex:2"><label>Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</label><input id="loginCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²"/></div>
    </div>
    <div class="actions">
      <button class="primary" onclick="completeLogin()">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="ghost" onclick="closeLogin()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <p id="loginStatus" class="muted"></p>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* Quotes */
const quotes = [
  "ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ... Ø±Ø­Ù„ØªÙƒ ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§",
  "Ù…Ø¹ ØªÙˆØµÙŠÙ„Ø§ØªÙŠØŒ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø£Ø³Ù‡Ù„ ÙˆØ£Ù‚Ø±Ø¨",
  "Ø§Ø®ØªØ± Ø±Ø­Ù„ØªÙƒ Ø¨Ø«Ù‚Ø© ÙˆØ³Ù‡ÙˆÙ„Ø©",
  "ØªÙˆØµÙŠÙ„Ø§ØªÙŠ... Ø­ÙŠØ« ÙŠÙ„ØªÙ‚ÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø§Ù„Ø²Ø¨ÙˆÙ†",
  "Ø±Ø­Ù„Ø§Øª Ø¢Ù…Ù†Ø© ÙˆØ³Ù‡Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø¯Ù†"
];

/* Regions */
const REGIONS = ["Ø§Ø±Ø¨Ø¯Ù‘","Ø§Ù„ÙƒÙˆØ±Ø©","Ø§Ù„Ø­ÙŠ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ","Ø§Ù„Ø­ÙŠ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠ","ÙƒÙØ± ÙŠÙˆØ¨Ø§","Ø§Ù„Ø·ÙŠØ¨Ø©","Ø¹Ù…Ø§Ù†","Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡","Ø§Ù„Ø¹Ù‚Ø¨Ø©"];

/* State */
let role = null;
let map, userMarker;
let watchId = null;
let currentUser = null; // {name, phone, consent}
let verificationCode = null;
let driverProfile = null; // car + person
let offers = JSON.parse(localStorage.getItem("offers")||"[]"); // [{id,driverPhone,from,to,price,seatsLeft,time,notes,driverProfile,lat,lng}]
let requests = JSON.parse(localStorage.getItem("requests")||"[]"); // [{offerId, customer, status, distanceKm, seats, note}]
let chats = JSON.parse(localStorage.getItem("chats")||"{}"); // {offerId: [ {name, msg, ts} ] }
let selectedOfferId = null;

/* Utils */
const $ = id => document.getElementById(id);
function saveLS(){ localStorage.setItem("offers", JSON.stringify(offers)); localStorage.setItem("requests", JSON.stringify(requests)); localStorage.setItem("chats", JSON.stringify(chats)); }
function fmt(n){ return Number(n).toLocaleString("ar-JO"); }
function validateJordanPhone(p){ return /^\+9627\d{8}$/.test((p||"").trim()); }
function haversineKm(aLat,aLng,bLat,bLng){
  const toRad = d=>d*Math.PI/180;
  const R=6371;
  const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
  const s1=Math.sin(dLat/2)**2;
  const s2=Math.sin(dLng/2)**2*Math.cos(toRad(aLat))*Math.cos(toRad(bLat));
  return 2*R*Math.asin(Math.sqrt(s1+s2));
}

/* Welcome quotes rotation */
(function rotateQuotes(){
  let i=0;
  const el=$("welcomeQuote");
  el.textContent=quotes[i];
  setInterval(()=>{ i=(i+1)%quotes.length; el.textContent=quotes[i]; }, 3000);
})();

/* Populate region selects */
function populateRegions(){
  ["fromRegion","toRegion","filterFrom","filterTo"].forEach(id=>{
    const sel=$(id); sel.innerHTML="";
    const optAny = document.createElement("option");
    optAny.value=""; optAny.textContent = id.includes("filter") ? "Ø§Ù„ÙƒÙ„" : "Ø§Ø®ØªØ±";
    sel.appendChild(optAny);
    REGIONS.forEach(r=>{
      const o=document.createElement("option");
      o.value=r; o.textContent=r; sel.appendChild(o);
    });
  });
}
populateRegions();

/* Map init */
function initMap(){
  map = L.map("map").setView([31.95,35.91], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(map);
  window.addEventListener("resize", ()=>map.invalidateSize());
}
initMap();

/* Geolocation */
function startLocationWatch(){
  if(!navigator.geolocation) return;
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude:lat, longitude:lng} = pos.coords;
    if(userMarker) userMarker.setLatLng([lat,lng]);
    else userMarker = L.marker([lat,lng]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ").openPopup();
  }, err=>{}, {enableHighAccuracy:true, maximumAge:5000, timeout:10000});
}

/* Role and login flow */
function openLogin(r){
  role = r;
  $("loginTitle").textContent = r==="driver" ? "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚" : "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†";
  $("welcomeModal").classList.add("hidden");
  $("loginModal").classList.remove("hidden");
}
function closeLogin(){
  $("loginModal").classList.add("hidden");
  $("welcomeModal").classList.remove("hidden");
}
function sendVerification(){
  const phone=$("loginPhone").value;
  if(!validateJordanPhone(phone)){ $("loginStatus").textContent="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (+9627XXXXXXXX)"; $("loginStatus").className="error"; return; }
  verificationCode = String(Math.floor(100000+Math.random()*900000));
  $("loginStatus").textContent = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (Ù…Ø­Ø§ÙƒØ§Ø©): " + verificationCode;
  $("loginStatus").className="success";
}
function completeLogin(){
  const name=$("loginName").value.trim();
  const phone=$("loginPhone").value.trim();
  const code=$("loginCode").value.trim();
  const consent=$("loginConsent").checked;

  if(!name){ $("loginStatus").textContent="ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…"; $("loginStatus").className="error"; return; }
  if(!validateJordanPhone(phone)){ $("loginStatus").textContent="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­"; $("loginStatus").className="error"; return; }
  if(!verificationCode || code!==verificationCode){ $("loginStatus").textContent="Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­"; $("loginStatus").className="error"; return; }
  if(!consent){ $("loginStatus").textContent="ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"; $("loginStatus").className="error"; return; }

  currentUser = {name, phone, consent, role};
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  $("loginModal").classList.add("hidden");
  $("btnLogout").classList.remove("hidden");
  $("btnRoleCustomer").classList.remove("hidden");
  $("btnRoleDriver").classList.remove("hidden");
  startLocationWatch();

  if(role==="driver"){
    $("roleSelect").classList.add("hidden");
    $("driverSetup").classList.remove("hidden");
    $("customerView").classList.add("hidden");
  }else{
    $("roleSelect").classList.add("hidden");
    $("driverSetup").classList.add("hidden");
    $("customerView").classList.remove("hidden");
    renderOffers();
  }
}
$("btnLogout").onclick = ()=>{
  localStorage.removeItem("currentUser");
  currentUser=null; verificationCode=null;
  $("driverSetup").classList.add("hidden");
  $("customerView").classList.add("hidden");
  $("roleSelect").classList.remove("hidden");
  $("btnLogout").classList.add("hidden");
  $("btnRoleCustomer").classList.add("hidden");
  $("btnRoleDriver").classList.add("hidden");
  $("welcomeModal").classList.remove("hidden");
};

/* Header quick switches */
$("btnRoleCustomer").onclick=()=>{
  role="customer";
  $("driverSetup").classList.add("hidden");
  $("customerView").classList.remove("hidden");
  renderOffers();
};
$("btnRoleDriver").onclick=()=>{
  role="driver";
  $("customerView").classList.add("hidden");
  $("driverSetup").classList.remove("hidden");
  renderDriverRequests();
};

/* Driver profile save */
$("carPhotos").addEventListener("change", e=>{
  const preview=$("photoPreview"); preview.innerHTML="";
  [...e.target.files].slice(0,6).forEach(file=>{
    const reader=new FileReader();
    reader.onload=()=>{ const img=document.createElement("img"); img.src=reader.result; preview.appendChild(img); };
    reader.readAsDataURL(file);
  });
});

function saveDriverProfile(){
  const name=$("drvName").value.trim();
  const phone=$("drvPhone").value.trim();
  const age=parseInt($("drvAge").value||0,10);
  const gender=$("drvGender").value;
  const rating=parseFloat($("drvRating").value||0);
  const carNumber=$("carNumber").value.trim();
  const carColor=$("carColor").value.trim();
  const carBrand=$("carBrand").value.trim();
  const carModel=$("carModel").value.trim();
  const consent=$("shareLocConsent").checked;

  if(!name || !validateJordanPhone(phone) || !carNumber){ $("drvSaveStatus").textContent="ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©"; $("drvSaveStatus").className="error"; return; }

  // collect preview images (base64)
  const imgs=[...$("photoPreview").querySelectorAll("img")].map(img=>img.src);

  driverProfile = {name, phone, age, gender, rating, carNumber, carColor, carBrand, carModel, photos:imgs, consent};
  localStorage.setItem("driverProfile", JSON.stringify(driverProfile));
  $("drvSaveStatus").textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­";
  $("drvSaveStatus").className = "success";
}

/* Publish offer */
function publishOffer(){
  if(!driverProfile){ $("offerStatus").textContent="ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£ÙˆÙ„Ø§Ù‹"; $("offerStatus").className="error"; return; }
  const from=$("fromRegion").value;
  const to=$("toRegion").value;
  const price=parseFloat($("offerPrice").value||0);
  const seats=parseInt($("offerSeats").value||0,10);
  const time=$("offerTime").value;
  const notes=$("offerNotes").value.trim();

  if(!from || !to || price<=0 || seats<=0 || !time){
    $("offerStatus").textContent="Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"; $("offerStatus").className="error"; return;
  }

  let lat=null,lng=null;
  if(userMarker){ const ll=userMarker.getLatLng(); lat=ll.lat; lng=ll.lng; }

  const id="offer_"+Date.now();
  const offer={id, driverPhone:driverProfile.phone, from, to, price, seatsLeft:seats, time, notes, driverProfile, lat, lng};
  offers.unshift(offer);
  saveLS();
  $("offerStatus").textContent="ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­";
  $("offerStatus").className="success";
  renderOffers();
}

/* Offers render & filters */
function offerCard(o){
  const dp=o.driverProfile;
  const seats = o.seatsLeft;
  const distanceText = (o.lat!=null && o.lng!=null && userMarker) ? 
    (haversineKm(userMarker.getLatLng().lat, userMarker.getLatLng().lng, o.lat, o.lng).toFixed(1) + " ÙƒÙ…") : "â€”";
  return `
    <div class="offer">
      <div class="offer-header">
        <div><strong>${dp.name}</strong> â€¢ ${dp.carBrand} ${dp.carModel} â€¢ ${dp.carNumber}</div>
        <span class="badge">${o.from} â†’ ${o.to}</span>
      </div>
      <div class="tags">
        <span class="tag">Ø§Ù„Ù‡Ø§ØªÙ: ${dp.phone}</span>
        <span class="tag">Ø§Ù„Ø¹Ù…Ø±: ${dp.age||"-"}</span>
        <span class="tag">Ø§Ù„Ø¬Ù†Ø³: ${dp.gender}</span>
        <span class="tag">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${dp.rating||"-"}</span>
        <span class="tag">Ø§Ù„Ø³Ø¹Ø±: ${fmt(o.price)} Ø¯</span>
        <span class="tag">Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©: ${seats}</span>
        <span class="tag">Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distanceText}</span>
        <span class="tag">Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: ${o.time.replace("T"," ")} </span>
      </div>
      <div class="muted">${o.notes||""}</div>
      <div class="offer-actions">
        <button class="sm accept" onclick="selectOffer('${o.id}')">Ø§Ø®ØªÙŠØ§Ø±</button>
        <button class="sm" onclick="focusOfferOnMap('${o.id}')">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      </div>
    </div>
  `;
}

function renderOffers(){
  const list=$("offersList");
  let fFrom=$("filterFrom").value, fTo=$("filterTo").value;
  let filtered = offers.filter(o=>(!fFrom || o.from===fFrom) && (!fTo || o.to===fTo));
  list.innerHTML = filtered.length ? filtered.map(offerCard).join("") : "<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>";
}

function focusOfferOnMap(id){
  const o = offers.find(x=>x.id===id);
  if(!o || o.lat==null || o.lng==null){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©"); return; }
  const m = L.marker([o.lat,o.lng]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚").openPopup();
  map.setView([o.lat,o.lng], 14);
  setTimeout(()=>{ try{ map.removeLayer(m); }catch{} }, 4000);
}

function applyFilters(){ renderOffers(); }
function clearFilters(){ $("filterFrom").value=""; $("filterTo").value=""; renderOffers(); }

/* Select offer and book */
function selectOffer(id){
  selectedOfferId = id;
  const o = offers.find(x=>x.id===id);
  if(!o){ alert("Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }

  // compute distance
  let distanceKm = null;
  if(userMarker && o.lat!=null && o.lng!=null){
    const me=userMarker.getLatLng();
    distanceKm = haversineKm(me.lat, me.lng, o.lat, o.lng);
  }

  const seatsRequested = parseInt($("lateSeats").value||1,10);
  const note = $("lateNote").value;

  if(o.seatsLeft < seatsRequested){ alert("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"); return; }

  const request = {
    offerId:id,
    customer: currentUser || {name:"Ø²Ø¨ÙˆÙ†", phone:""},
    seats: seatsRequested,
    note,
    status: (distanceKm!=null && distanceKm>6) ? "pending_driver_review" : "auto_accepted",
    distanceKm: distanceKm
  };
  requests.unshift(request);
  saveLS();

  // auto-accept if within 6km, else driver must accept
  if(request.status==="auto_accepted"){
    o.seatsLeft -= seatsRequested;
    saveLS();
    alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­Ø¬Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø¶Ù…Ù† Ù¦ ÙƒÙ…)");
    joinChat(id);
  }else{
    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø³ÙŠÙ‚Ø±Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø±ÙØ¶ (Ø£ÙƒØ«Ø± Ù…Ù† Ù¦ ÙƒÙ…).");
  }

  renderOffers();
  renderDriverRequests();
}

/* Driver requests handling */
function renderDriverRequests(){
  const container = $("driverRequests");
  const myPhone = driverProfile?.phone || JSON.parse(localStorage.getItem("driverProfile")||"{}").phone;
  const myOffers = offers.filter(o=>o.driverPhone===myPhone).map(o=>o.id);
  const myReqs = requests.filter(r=>myOffers.includes(r.offerId));

  if(!myReqs.length){ container.innerHTML="<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>"; return; }

  container.innerHTML = myReqs.map(r=>{
    const o = offers.find(x=>x.id===r.offerId);
    return `
      <div class="offer">
        <div class="offer-header">
          <div><strong>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong> â€¢ ${o.from} â†’ ${o.to}</div>
          <span class="badge">${r.status==="pending_driver_review" ? "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚" : "Ù…Ù‚Ø¨ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"}</span>
        </div>
        <div class="tags">
          <span class="tag">Ø§Ù„Ø²Ø¨ÙˆÙ†: ${r.customer.name}</span>
          <span class="tag">Ù…Ù‚Ø§Ø¹Ø¯ Ù…Ø·Ù„ÙˆØ¨Ø©: ${r.seats}</span>
          <span class="tag">Ø§Ù„Ù…Ø³Ø§ÙØ©: ${r.distanceKm!=null ? r.distanceKm.toFixed(1)+" ÙƒÙ…" : "â€”"}</span>
          <span class="tag">Ù…ØªØ¨Ù‚ÙŠ: ${o.seatsLeft}</span>
        </div>
        <div class="muted">${r.note||""}</div>
        <div class="offer-actions">
          ${r.status==="pending_driver_review" ? `
            <button class="sm accept" onclick="driverAccept('${r.offerId}', ${r.seats})">Ù‚Ø¨ÙˆÙ„</button>
            <button class="sm reject" onclick="driverReject('${r.offerId}')">Ø±ÙØ¶</button>
          ` : `<button class="sm" onclick="joinChat('${r.offerId}')">ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>`}
        </div>
      </div>
    `;
  }).join("");
}

function driverAccept(offerId, seats){
  const o = offers.find(x=>x.id===offerId);
  if(!o) return;
  if(o.seatsLeft<seats){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø¹Ø¯ ÙƒØ§ÙÙŠØ©"); return; }
  o.seatsLeft-=seats;
  requests = requests.map(r=> r.offerId===offerId && r.status==="pending_driver_review" ? {...r, status:"accepted"} : r);
  saveLS();
  renderDriverRequests();
  joinChat(offerId);
}
function driverReject(offerId){
  requests = requests.map(r=> r.offerId===offerId && r.status==="pending_driver_review" ? {...r, status:"rejected"} : r);
  saveLS();
  renderDriverRequests();
}

/* Chat */
function joinChat(offerId){
  selectedOfferId = offerId;
  if(!chats[offerId]) chats[offerId]=[];
  renderChat();
}
function renderChat(){
  const box=$("chatBox");
  if(!selectedOfferId){ box.innerHTML="<p class='muted'>Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ ÙˆØ§Ù†Ø¶Ù… Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>"; return; }
  const msgs = chats[selectedOfferId]||[];
  box.innerHTML = msgs.length ? msgs.map(m=>`
    <div class="chat-msg">
      <div class="chat-meta">${m.name} â€¢ ${new Date(m.ts).toLocaleString('ar-JO')}</div>
      <div>${m.msg}</div>
    </div>
  `).join("") : "<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>";
  box.scrollTop = box.scrollHeight;
}
function sendChat(){
  const msg=$("chatInput").value.trim();
  if(!msg) return;
  if(!selectedOfferId){ alert("Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø±Ø¶ Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const name = currentUser?.name || "Ù…Ø³ØªØ®Ø¯Ù…";
  chats[selectedOfferId] = chats[selectedOfferId] || [];
  chats[selectedOfferId].push({name, msg, ts:Date.now()});
  $("chatInput").value="";
  saveLS();
  renderChat();
}

/* Restore session */
(function restore(){
  const cu = localStorage.getItem("currentUser");
  if(cu){
    currentUser = JSON.parse(cu);
    role = currentUser.role;
    $("welcomeModal").classList.add("hidden");
    $("btnLogout").classList.remove("hidden");
    $("btnRoleCustomer").classList.remove("hidden");
    $("btnRoleDriver").classList.remove("hidden");
    startLocationWatch();
    if(role==="driver"){
      $("driverSetup").classList.remove("hidden");
      const dp = localStorage.getItem("driverProfile"); if(dp) driverProfile=JSON.parse(dp);
      renderDriverRequests();
    }else{
      $("customerView").classList.remove("hidden");
      renderOffers();
    }
  }
})();
</script>
</body>
</html>
