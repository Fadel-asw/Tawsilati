<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root{
  --green:#12b886; --green-dark:#0f9a72; --bg1:#eafaf1; --bg2:#d7f2e4; --text:#122; --muted:#5b6b6b; --card:#ffffffcc;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:"Segoe UI", Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg,var(--bg1), var(--bg2));
  color:var(--text); direction:rtl; display:flex; flex-direction:column;
}
header{
  background:var(--green); color:#fff; padding:16px 20px; display:flex; align-items:center; justify-content:space-between;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.brand{display:flex; align-items:center; gap:10px; font-weight:bold; font-size:20px}
.header-actions{display:flex; gap:8px}
header button{border:none; background:#fff; color:var(--green); border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600}
header button:hover{background:#f3fef8}
.main{display:grid; grid-template-columns: 380px 1fr; gap:16px; padding:16px; flex:1}
@media (max-width: 960px){ .main{grid-template-columns: 1fr} }
.card{
  background:var(--card); backdrop-filter:blur(10px); border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,0.08);
  padding:16px; transition:transform .25s ease, opacity .25s ease;
}
.card h3{margin:0 0 10px 0}
.muted{color:var(--muted); font-size:14px}
button.primary{
  width:100%; padding:12px; border:none; border-radius:10px; background:var(--green); color:#fff; font-size:16px; cursor:pointer;
  transition:transform .2s ease, background .2s ease;
}
button.primary:hover{background:var(--green-dark); transform:scale(1.02)}
button.ghost{width:100%; padding:12px; border:2px solid var(--green); border-radius:10px; color:var(--green); background:transparent; cursor:pointer}
.input{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
.input label{font-size:14px; color:#244}
.input input, .input select{padding:10px; border:1px solid #cfd8d8; border-radius:10px; font-size:15px; background:#fff}
.row{display:flex; gap:10px}
.row > *{flex:1}
#map{width:100%; height:100%; min-height:420px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
.modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.25); z-index:1000; padding:16px}
.modal .window{
  max-width:720px; width:100%; background:var(--card); backdrop-filter:blur(12px); border-radius:16px; padding:22px;
  box-shadow:0 10px 28px rgba(0,0,0,0.15); animation:pop .25s ease;
}
@keyframes pop{from{transform:scale(.98); opacity:0} to{transform:scale(1); opacity:1}}
.actions{display:flex; gap:10px; margin-top:12px}
.offer{border:1px solid #e5efef; border-radius:12px; padding:12px; margin-bottom:10px; background:#fff}
.offer-header{display:flex; justify-content:space-between; align-items:center}
.badge{background:#effaf5; color:var(--green-dark); padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
.tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
.tag{background:#f2fbf7; color:#285; padding:4px 8px; border-radius:999px; font-size:12px}
.offer-actions{display:flex; gap:8px; margin-top:10px}
button.sm{padding:8px 10px; border:none; border-radius:8px; cursor:pointer}
button.accept{background:var(--green); color:#fff}
button.reject{background:#f44336; color:#fff}
.chat{border:1px solid #e5efef; border-radius:12px; padding:10px; background:#fff; max-height:220px; overflow:auto}
.chat-msg{margin-bottom:8px}
.chat-meta{font-size:12px; color:#666}
.hidden{display:none}
.success{color:#1b8a5a} .error{color:#c62828}
.preview{display:flex; gap:8px; flex-wrap:wrap}
.preview img{width:84px; height:84px; object-fit:cover; border-radius:10px; border:1px solid #e5efef}
#recaptcha-container{margin-top:8px}
</style>
</head>
<body>

<header>
  <div class="brand">ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</div>
  <div class="header-actions">
    <button id="btnRoleCustomer" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
    <button id="btnRoleDriver" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
    <button id="btnLogout" class="hidden">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<div class="main">
  <!-- Left column: Controls -->
  <div class="card" id="panelControls">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <p class="muted">Ø§Ø®ØªØ± Ø¯ÙˆØ±ÙƒØŒ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ ÙˆØ§Ù†Ø´Ø± Ø£Ùˆ Ø§Ø­Ø¬Ø² Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>

    <!-- Role selection -->
    <div id="roleSelect" class="actions">
      <button class="primary" onclick="openLogin('customer')">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†</button>
      <button class="ghost" onclick="openLogin('driver')">Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>

    <!-- Driver setup -->
    <div id="driverSetup" class="hidden">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>
      <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="drvName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯"/></div>
      <div class="row">
        <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø£Ø±Ø¯Ù†)</label><input id="drvPhone" placeholder="+9627XXXXXXXX"/></div>
        <div class="input"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="drvAge" type="number" min="18" placeholder="Ø§Ù„Ø¹Ù…Ø±"/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="drvGender"><option>Ø°ÙƒØ±</option><option>Ø£Ù†Ø«Ù‰</option></select>
        </div>
        <div class="input"><label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label><input id="drvRating" type="number" step="0.1" min="0" max="5" placeholder="4.8"/></div>
      </div>

      <div class="row">
        <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©"/></div>
        <div class="input"><label>Ù„ÙˆÙ† Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carColor" placeholder="Ø£Ø¨ÙŠØ¶ØŒ Ø£Ø³ÙˆØ¯..."/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carBrand" placeholder="ØªÙˆÙŠÙˆØªØ§ØŒ Ù‡ÙˆÙ†Ø¯Ø§..."/></div>
        <div class="input"><label>Ù†ÙˆØ¹/Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carModel" placeholder="ÙƒÙˆØ±ÙˆÙ„Ø§ØŒ Ø³ÙŠÙÙŠÙƒ..."/></div>
      </div>

      <div class="input">
        <label>ØµÙˆØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <input id="carPhotos" type="file" multiple accept="image/*"/>
        <div id="photoPreview" class="preview"></div>
      </div>

      <div class="input">
        <label><input type="checkbox" id="shareLocConsent"/> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</label>
      </div>

      <button class="primary" onclick="saveDriverProfile()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
      <p id="drvSaveStatus" class="muted"></p>

      <hr/>

      <h3>Ù†Ø´Ø± Ø¹Ø±Ø¶ Ø±Ø­Ù„Ø©</h3>
      <div class="row">
        <div class="input"><label>Ù…Ù†</label><select id="fromRegion"></select></div>
        <div class="input"><label>Ø¥Ù„Ù‰</label><select id="toRegion"></select></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙŠÙ†Ø§Ø±)</label><input id="offerPrice" type="number" min="0" step="0.5"/></div>
        <div class="input"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯</label><input id="offerSeats" type="number" min="1"/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label><input id="offerTime" type="datetime-local"/></div>
        <div class="input"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="offerNotes" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"/></div>
      </div>

      <button class="primary" onclick="publishOffer()">Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶</button>
      <p id="offerStatus" class="muted"></p>

      <hr/>

      <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h3>
      <div id="driverRequests"></div>
    </div>

    <!-- Customer view -->
    <div id="customerView" class="hidden">
      <h3>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
      <div class="row">
        <div class="input"><label>Ù…Ù†</label><select id="filterFrom"></select></div>
        <div class="input"><label>Ø¥Ù„Ù‰</label><select id="filterTo"></select></div>
      </div>
      <div class="row">
        <button class="primary" onclick="applyFilters()">ØªØµÙÙŠØ©</button>
        <button class="ghost" onclick="clearFilters()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØµÙÙŠØ©</button>
      </div>

      <div id="offersList" style="margin-top:10px;"></div>

      <hr/>
      <h3>Ø­Ø¬Ø² Ù„Ø§Ø­Ù‚ (Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¯Ø¯)</h3>
      <div class="row">
        <div class="input"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label><input id="lateSeats" type="number" min="1" value="1"/></div>
        <div class="input"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="lateNote" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù‚ÙŠØ¨Ø© ÙƒØ¨ÙŠØ±Ø©"/></div>
      </div>
      <p class="muted">Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· "Ø§Ø®ØªÙŠØ§Ø±" Ø«Ù… "Ø­Ø¬Ø²".</p>
    </div>
  </div>

  <!-- Right column: Map & chat -->
  <div class="card">
    <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­ÙŠØ©</h3>
    <p class="muted">ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…ÙˆØ§Ù‚Ø¹Ùƒ ÙˆÙ…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª. ÙŠØ³Ù…Ø­ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ø¨Ø¹Ø¯ Ù…Ù† Ù¦ ÙƒÙ….</p>
    <div id="map"></div>

    <hr/>
    <h3>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h3>
    <div id="chatBox" class="chat"></div>
    <div class="row">
      <input id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©..."/>
      <button class="primary" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<!-- Welcome modal -->
<div class="modal" id="welcomeModal">
  <div class="window">
    <h2 style="margin-top:0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <span style="color:var(--green)">ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</span></h2>
    <p id="welcomeQuote" class="muted" style="font-size:16px;"></p>
    <div class="actions">
      <button class="primary" onclick="openLogin('customer')">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†</button>
      <button class="ghost" onclick="openLogin('driver')">Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>
  </div>
</div>

<!-- Login modal -->
<div class="modal hidden" id="loginModal">
  <div class="window">
    <h3 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <div class="row">
      <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="loginName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ"/></div>
      <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø£Ø±Ø¯Ù†)</label><input id="loginPhone" placeholder="+9627XXXXXXXX"/></div>
    </div>
    <div class="input"><label><input type="checkbox" id="loginConsent"/> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</label></div>
    <div id="recaptcha-container"></div>
    <div class="row">
      <button class="primary" onclick="sendVerification()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</button>
      <div class="input" style="flex:2"><label>Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</label><input id="loginCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²"/></div>
    </div>
    <div class="actions">
      <button class="primary" onclick="completeLogin()">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="ghost" onclick="closeLogin()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <p id="loginStatus" class="muted"></p>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase v10 compat SDKs (simplifies usage in single file) -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage-compat.js"></script>

<script>
/* Firebase config (provided) */
const firebaseConfig = {
  apiKey: "AIzaSyDQtw1wHvarCO9WS3E-HVafkBWEkimnWfI",
  authDomain: "tawsilati-f175e.firebaseapp.com",
  projectId: "tawsilati-f175e",
  storageBucket: "tawsilati-f175e.firebasestorage.app",
  messagingSenderId: "181685598480",
  appId: "1:181685598480:web:3f712bf3252b6660dccd95",
  measurementId: "G-FVY6YCKREP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* Quotes */
const quotes = [
  "ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ... Ø±Ø­Ù„ØªÙƒ ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§",
  "Ù…Ø¹ ØªÙˆØµÙŠÙ„Ø§ØªÙŠØŒ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø£Ø³Ù‡Ù„ ÙˆØ£Ù‚Ø±Ø¨",
  "Ø§Ø®ØªØ± Ø±Ø­Ù„ØªÙƒ Ø¨Ø«Ù‚Ø© ÙˆØ³Ù‡ÙˆÙ„Ø©",
  "ØªÙˆØµÙŠÙ„Ø§ØªÙŠ... Ø­ÙŠØ« ÙŠÙ„ØªÙ‚ÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø§Ù„Ø²Ø¨ÙˆÙ†",
  "Ø±Ø­Ù„Ø§Øª Ø¢Ù…Ù†Ø© ÙˆØ³Ù‡Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø¯Ù†"
];

/* Regions */
const REGIONS = ["Ø§Ø±Ø¨Ø¯Ù‘","Ø§Ù„ÙƒÙˆØ±Ø©","Ø§Ù„Ø­ÙŠ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ","Ø§Ù„Ø­ÙŠ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠ","ÙƒÙØ± ÙŠÙˆØ¨Ø§","Ø§Ù„Ø·ÙŠØ¨Ø©","Ø¹Ù…Ø§Ù†","Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡","Ø§Ù„Ø¹Ù‚Ø¨Ø©"];

/* State */
let role = null;
let map, userMarker;
let watchId = null;
let currentUser = null; // {uid, name, phone, consent, role}
let selectedOfferId = null;
let recaptchaVerifier = null;

/* Utils */
const $ = id => document.getElementById(id);
function fmt(n){ return Number(n).toLocaleString("ar-JO"); }
function validateJordanPhone(p){ return /^\+9627\d{8}$/.test((p||"").trim()); }
function haversineKm(aLat,aLng,bLat,bLng){
  const toRad = d=>d*Math.PI/180, R=6371;
  const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
  const s1=Math.sin(dLat/2)**2;
  const s2=Math.sin(dLng/2)**2*Math.cos(toRad(aLat))*Math.cos(toRad(bLat));
  return 2*R*Math.asin(Math.sqrt(s1+s2));
}

/* Welcome quotes rotation */
(function rotateQuotes(){
  let i=0; const el=$("welcomeQuote");
  el.textContent=quotes[i];
  setInterval(()=>{ i=(i+1)%quotes.length; el.textContent=quotes[i]; }, 3000);
})();

/* Populate region selects */
function populateRegions(){
  ["fromRegion","toRegion","filterFrom","filterTo"].forEach(id=>{
    const sel=$(id); sel.innerHTML="";
    const optAny = document.createElement("option");
    optAny.value=""; optAny.textContent = id.includes("filter") ? "Ø§Ù„ÙƒÙ„" : "Ø§Ø®ØªØ±";
    sel.appendChild(optAny);
    REGIONS.forEach(r=>{
      const o=document.createElement("option");
      o.value=r; o.textContent=r; sel.appendChild(o);
    });
  });
}
populateRegions();

/* Map init */
function initMap(){
  map = L.map("map").setView([31.95,35.91], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(map);
  window.addEventListener("resize", ()=>map.invalidateSize());
}
initMap();

/* Geolocation */
function startLocationWatch(){
  if(!navigator.geolocation) return;
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude:lat, longitude:lng} = pos.coords;
    if(userMarker) userMarker.setLatLng([lat,lng]);
    else userMarker = L.marker([lat,lng]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ").openPopup();
  }, err=>{}, {enableHighAccuracy:true, maximumAge:5000, timeout:10000});
}

/* Role and login flow */
function openLogin(r){
  role = r;
  $("loginTitle").textContent = r==="driver" ? "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚" : "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†";
  $("welcomeModal").classList.add("hidden");
  $("loginModal").classList.remove("hidden");
  if(!recaptchaVerifier){
    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
    recaptchaVerifier.render();
  }
}
function closeLogin(){
  $("loginModal").classList.add("hidden");
  $("welcomeModal").classList.remove("hidden");
}
function sendVerification(){
  const phone=$("loginPhone").value.trim();
  const name=$("loginName").value.trim();
  const consent=$("loginConsent").checked;

  if(!name){ $("loginStatus").textContent="ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…"; $("loginStatus").className="error"; return; }
  if(!validateJordanPhone(phone)){ $("loginStatus").textContent="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (+9627XXXXXXXX)"; $("loginStatus").className="error"; return; }
  if(!consent){ $("loginStatus").textContent="ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"; $("loginStatus").className="error"; return; }

  auth.signInWithPhoneNumber(phone, recaptchaVerifier)
    .then(confirmationResult => {
      window.confirmationResult = confirmationResult;
      $("loginStatus").textContent = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚ØµÙŠØ±Ø©";
      $("loginStatus").className="success";
    })
    .catch(error => {
      $("loginStatus").textContent = "Ø®Ø·Ø£: " + (error && error.message ? error.message : "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²");
      $("loginStatus").className="error";
    });
}
function completeLogin(){
  const code=$("loginCode").value.trim();
  if(!window.confirmationResult){ $("loginStatus").textContent="Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù…Ø² Ø£ÙˆÙ„Ø§Ù‹"; $("loginStatus").className="error"; return; }
  window.confirmationResult.confirm(code)
    .then(result=>{
      const user = result.user;
      const name=$("loginName").value.trim();
      const consent=$("loginConsent").checked;

      currentUser = {uid:user.uid, name, phone:user.phoneNumber, consent, role};
      localStorage.setItem("currentUser", JSON.stringify(currentUser));

      // Save/merge user profile
      db.collection("users").doc(user.uid).set(currentUser, {merge:true});

      $("loginModal").classList.add("hidden");
      $("btnLogout").classList.remove("hidden");
      $("btnRoleCustomer").classList.remove("hidden");
      $("btnRoleDriver").classList.remove("hidden");
      startLocationWatch();

      if(role==="driver"){
        $("roleSelect").classList.add("hidden");
        $("driverSetup").classList.remove("hidden");
        $("customerView").classList.add("hidden");
        renderDriverRequests();
      }else{
        $("roleSelect").classList.add("hidden");
        $("driverSetup").classList.add("hidden");
        $("customerView").classList.remove("hidden");
        subscribeOffers();
      }
    })
    .catch(error=>{
      $("loginStatus").textContent="Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­";
      $("loginStatus").className="error";
    });
}
$("btnLogout").onclick = ()=>{
  auth.signOut();
  localStorage.removeItem("currentUser");
  currentUser=null; window.confirmationResult=null;
  $("driverSetup").classList.add("hidden");
  $("customerView").classList.add("hidden");
  $("roleSelect").classList.remove("hidden");
  $("btnLogout").classList.add("hidden");
  $("btnRoleCustomer").classList.add("hidden");
  $("btnRoleDriver").classList.add("hidden");
  $("welcomeModal").classList.remove("hidden");
};

/* Header quick switches */
$("btnRoleCustomer").onclick=()=>{
  role="customer";
  $("driverSetup").classList.add("hidden");
  $("customerView").classList.remove("hidden");
  subscribeOffers();
};
$("btnRoleDriver").onclick=()=>{
  role="driver";
  $("customerView").classList.add("hidden");
  $("driverSetup").classList.remove("hidden");
  renderDriverRequests();
};

/* Image previews */
$("carPhotos").addEventListener("change", e=>{
  const preview=$("photoPreview"); preview.innerHTML="";
  [...e.target.files].slice(0,6).forEach(file=>{
    const reader=new FileReader();
    reader.onload=()=>{ const img=document.createElement("img"); img.src=reader.result; preview.appendChild(img); };
    reader.readAsDataURL(file);
  });
});

/* Upload car photos to Firebase Storage */
async function uploadCarPhotos(files){
  const urls=[];
  for(const file of files){
    const ref = storage.ref(`cars/${currentUser.uid}/${Date.now()}_${file.name}`);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    urls.push(url);
  }
  return urls;
}

/* Save driver profile to Firestore */
async function saveDriverProfile(){
  if(!currentUser || !currentUser.uid){ $("drvSaveStatus").textContent="Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"; $("drvSaveStatus").className="error"; return; }

  const name=$("drvName").value.trim();
  const phone=$("drvPhone").value.trim();
  const age=parseInt($("drvAge").value||0,10);
  const gender=$("drvGender").value;
  const rating=parseFloat($("drvRating").value||0);
  const carNumber=$("carNumber").value.trim();
  const carColor=$("carColor").value.trim();
  const carBrand=$("carBrand").value.trim();
  const carModel=$("carModel").value.trim();
  const consent=$("shareLocConsent").checked;

  if(!name || !validateJordanPhone(phone) || !carNumber){ $("drvSaveStatus").textContent="ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©"; $("drvSaveStatus").className="error"; return; }

  const files = $("carPhotos").files;
  let photoUrls=[];
  if(files && files.length){ photoUrls = await uploadCarPhotos(files).catch(()=>[]); }

  const profile = {name, phone, age, gender, rating, carNumber, carColor, carBrand, carModel, photos:photoUrls, consent};
  await db.collection("drivers").doc(currentUser.uid).set(profile, {merge:true});
  $("drvSaveStatus").textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­";
  $("drvSaveStatus").className = "success";
}

/* Publish offer to Firestore */
async function publishOffer(){
  if(!currentUser){ $("offerStatus").textContent="ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"; $("offerStatus").className="error"; return; }

  const from=$("fromRegion").value;
  const to=$("toRegion").value;
  const price=parseFloat($("offerPrice").value||0);
  const seats=parseInt($("offerSeats").value||0,10);
  const time=$("offerTime").value;
  const notes=$("offerNotes").value.trim();

  if(!from || !to || price<=0 || seats<=0 || !time){
    $("offerStatus").textContent="Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"; $("offerStatus").className="error"; return;
  }

  let lat=null,lng=null;
  if(userMarker){ const ll=userMarker.getLatLng(); lat=ll.lat; lng=ll.lng; }

  // merge driver profile for quick listing
  const dpSnap = await db.collection("drivers").doc(currentUser.uid).get();
  const driverProfile = dpSnap.exists ? dpSnap.data() : {name: currentUser.name, phone: currentUser.phone};

  const offer = {
    driverId: currentUser.uid, from, to, price, seatsLeft: seats, time, notes,
    driverProfile, lat, lng, createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("offers").add(offer);
  $("offerStatus").textContent="ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­";
  $("offerStatus").className="success";
}

/* Subscribe to offers (real-time) */
let offersUnsub = null;
function subscribeOffers(){
  if(offersUnsub) offersUnsub();
  const list=$("offersList");
  offersUnsub = db.collection("offers").orderBy("createdAt","desc").onSnapshot(snap=>{
    const fFrom=$("filterFrom").value, fTo=$("filterTo").value;
    let html="";
    snap.forEach(doc=>{
      const o=doc.data(); o.id=doc.id;
      if((!fFrom || o.from===fFrom) && (!fTo || o.to===fTo)){
        const dp=o.driverProfile||{};
        const distanceText = (o.lat!=null && o.lng!=null && userMarker) ? 
          (haversineKm(userMarker.getLatLng().lat, userMarker.getLatLng().lng, o.lat, o.lng).toFixed(1) + " ÙƒÙ…") : "â€”";
        html += `
          <div class="offer">
            <div class="offer-header">
              <div><strong>${dp.name||"-"}</strong> â€¢ ${dp.carBrand||"-"} ${dp.carModel||"-"} â€¢ ${dp.carNumber||"-"}</div>
              <span class="badge">${o.from} â†’ ${o.to}</span>
            </div>
            <div class="tags">
              <span class="tag">Ø§Ù„Ù‡Ø§ØªÙ: ${dp.phone||"-"}</span>
              <span class="tag">Ø§Ù„Ø¹Ù…Ø±: ${dp.age||"-"}</span>
              <span class="tag">Ø§Ù„Ø¬Ù†Ø³: ${dp.gender||"-"}</span>
              <span class="tag">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${dp.rating||"-"}</span>
              <span class="tag">Ø§Ù„Ø³Ø¹Ø±: ${fmt(o.price)} Ø¯</span>
              <span class="tag">Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©: ${o.seatsLeft}</span>
              <span class="tag">Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distanceText}</span>
              <span class="tag">Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: ${String(o.time).replace("T"," ")}</span>
            </div>
            <div class="muted">${o.notes||""}</div>
            <div class="offer-actions">
              <button class="sm accept" onclick="selectOffer('${o.id}', ${o.seatsLeft})">Ø§Ø®ØªÙŠØ§Ø±</button>
              <button class="sm" onclick="focusOfferOnMap('${o.lat}', '${o.lng}')">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
            </div>
          </div>
        `;
      }
    });
    list.innerHTML = html || "<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>";
  });
}

/* Filters */
function applyFilters(){ subscribeOffers(); }
function clearFilters(){ $("filterFrom").value=""; $("filterTo").value=""; subscribeOffers(); }

/* Map helpers */
function focusOfferOnMap(lat, lng){
  const lt = parseFloat(lat), lg=parseFloat(lng);
  if(isNaN(lt) || isNaN(lg)){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©"); return; }
  const m = L.marker([lt,lg]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚").openPopup();
  map.setView([lt,lg], 14);
  setTimeout(()=>{ try{ map.removeLayer(m); }catch{} }, 4000);
}

/* Select offer and book (creates request) */
async function selectOffer(offerId, seatsLeft){
  selectedOfferId = offerId;
  const seatsRequested = parseInt($("lateSeats").value||1,10);
  const note = $("lateNote").value;

  if(seatsLeft < seatsRequested){ alert("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"); return; }

  const offerDoc = await db.collection("offers").doc(offerId).get();
  if(!offerDoc.exists){ alert("Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }
  const o = offerDoc.data();

  // compute distance
  let distanceKm = null;
  if(userMarker && o.lat!=null && o.lng!=null){
    const me=userMarker.getLatLng();
    distanceKm = haversineKm(me.lat, me.lng, o.lat, o.lng);
  }

  const status = (distanceKm!=null && distanceKm>6) ? "pending_driver_review" : "auto_accepted";

  await db.collection("requests").add({
    offerId, customer: {uid: currentUser.uid, name: currentUser.name, phone: currentUser.phone},
    seats: seatsRequested, note, status, distanceKm,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  if(status==="auto_accepted"){
    await db.collection("offers").doc(offerId).update({seatsLeft: firebase.firestore.FieldValue.increment(-seatsRequested)});
    alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­Ø¬Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø¶Ù…Ù† Ù¦ ÙƒÙ…)");
    joinChat(offerId);
  }else{
    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø³ÙŠÙ‚Ø±Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø±ÙØ¶ (Ø£ÙƒØ«Ø± Ù…Ù† Ù¦ ÙƒÙ…).");
  }
}

/* Driver requests handling */
async function renderDriverRequests(){
  if(!currentUser) return;
  const myOffersSnap = await db.collection("offers").where("driverId","==", currentUser.uid).get();
  const myOfferIds = myOffersSnap.docs.map(d=>d.id);

  const reqSnap = await db.collection("requests").where("offerId","in", myOfferIds.length?myOfferIds:["none"]).get();
  const container = $("driverRequests");
  if(reqSnap.empty){ container.innerHTML="<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>"; return; }

  let html="";
  for(const doc of reqSnap.docs){
    const r=doc.data();
    const oSnap = await db.collection("offers").doc(r.offerId).get();
    const o = oSnap.data();
    html += `
      <div class="offer">
        <div class="offer-header">
          <div><strong>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong> â€¢ ${o.from} â†’ ${o.to}</div>
          <span class="badge">${r.status==="pending_driver_review" ? "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚" : (r.status==="auto_accepted" ? "Ù…Ù‚Ø¨ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" : r.status)}</span>
        </div>
        <div class="tags">
          <span class="tag">Ø§Ù„Ø²Ø¨ÙˆÙ†: ${r.customer.name}</span>
          <span class="tag">Ù…Ù‚Ø§Ø¹Ø¯ Ù…Ø·Ù„ÙˆØ¨Ø©: ${r.seats}</span>
          <span class="tag">Ø§Ù„Ù…Ø³Ø§ÙØ©: ${r.distanceKm!=null ? r.distanceKm.toFixed(1)+" ÙƒÙ…" : "â€”"}</span>
          <span class="tag">Ù…ØªØ¨Ù‚ÙŠ: ${o.seatsLeft}</span>
        </div>
        <div class="muted">${r.note||""}</div>
        <div class="offer-actions">
          ${r.status==="pending_driver_review" ? `
            <button class="sm accept" onclick="driverAccept('${r.offerId}', ${r.seats}, '${doc.id}')">Ù‚Ø¨ÙˆÙ„</button>
            <button class="sm reject" onclick="driverReject('${doc.id}')">Ø±ÙØ¶</button>
          ` : `<button class="sm" onclick="joinChat('${r.offerId}')">ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>`}
        </div>
      </div>
    `;
  }
  container.innerHTML = html;
}
async function driverAccept(offerId, seats, requestId){
  const oRef = db.collection("offers").doc(offerId);
  const oSnap = await oRef.get(); if(!oSnap.exists) return;
  const o = oSnap.data();
  if(o.seatsLeft<seats){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø¹Ø¯ ÙƒØ§ÙÙŠØ©"); return; }
  await oRef.update({seatsLeft: firebase.firestore.FieldValue.increment(-seats)});
  await db.collection("requests").doc(requestId).update({status:"accepted"});
  renderDriverRequests();
  joinChat(offerId);
}
async function driverReject(requestId){
  await db.collection("requests").doc(requestId).update({status:"rejected"});
  renderDriverRequests();
}

/* Chat (per-offer) */
function joinChat(offerId){
  selectedOfferId = offerId;
  renderChat();
}
let chatUnsub=null;
function renderChat(){
  const box=$("chatBox");
  if(chatUnsub) chatUnsub();
  if(!selectedOfferId){ box.innerHTML="<p class='muted'>Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ ÙˆØ§Ù†Ø¶Ù… Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>"; return; }

  chatUnsub = db.collection("chats").doc(selectedOfferId).collection("messages")
    .orderBy("ts","asc").onSnapshot(snap=>{
      let html="";
      snap.forEach(doc=>{
        const m=doc.data();
        html += `
          <div class="chat-msg">
            <div class="chat-meta">${m.name} â€¢ ${new Date(m.ts?.toDate?.() || m.ts).toLocaleString('ar-JO')}</div>
            <div>${m.msg}</div>
          </div>
        `;
      });
      box.innerHTML = html || "<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>";
      box.scrollTop = box.scrollHeight;
    });
}
function sendChat(){
  const msg=$("chatInput").value.trim();
  if(!msg) return;
  if(!selectedOfferId){ alert("Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø±Ø¶ Ø£ÙˆÙ„Ø§Ù‹"); return; }
  db.collection("chats").doc(selectedOfferId).collection("messages").add({
    name: currentUser?.name || "Ù…Ø³ØªØ®Ø¯Ù…", msg, ts: firebase.firestore.FieldValue.serverTimestamp()
  });
  $("chatInput").value="";
}

/* Restore session */
(function restore(){
  const cu = localStorage.getItem("currentUser");
  if(cu){
    currentUser = JSON.parse(cu);
    role = currentUser.role;
    $("welcomeModal").classList.add("hidden");
    $("btnLogout").classList.remove("hidden");
    $("btnRoleCustomer").classList.remove("hidden");
    $("btnRoleDriver").classList.remove("hidden");
    startLocationWatch();
    if(role==="driver"){
      $("driverSetup").classList.remove("hidden");
      renderDriverRequests();
    }else{
      $("customerView").classList.remove("hidden");
      subscribeOffers();
    }
  }
})();
</script>
</body>
</html>
