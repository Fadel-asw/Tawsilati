<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
/* Keep your previous styles intact */
:root{
  --green:#12b886;
  --green-dark:#0f9a72;
  --bg-grad-1:#eafaf1;
  --bg-grad-2:#d7f2e4;
  --text:#122;
  --muted:#5b6b6b;
  --card:#ffffffcc;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg,var(--bg-grad-1), var(--bg-grad-2));
  color:var(--text);
  direction:rtl;
  display:flex;
  flex-direction:column;
}
/* ... rest of your previous CSS ... */
</style>
</head>
<body>

<header>
  <div class="brand">ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</div>
  <div class="header-actions">
    <button id="btnRoleCustomer" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
    <button id="btnRoleDriver" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
    <button id="btnLogout" class="hidden">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<div class="main">
  <div class="card" id="panelControls">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <p class="muted">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ ÙˆØ§Ù†Ø·Ù„Ù‚.</p>
    <div id="roleSelect" class="actions">
      <button class="primary" onclick="openLogin('customer')">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†</button>
      <button class="ghost" onclick="openLogin('driver')">Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>

    <div id="driverSetup" class="hidden">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>
      <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="drvName" placeholder="Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯"/></div>
      <div class="row">
        <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="drvPhone" placeholder="+9627XXXXXXXX"/></div>
        <div class="input"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="drvAge" type="number"/></div>
      </div>
      <div class="input"><label>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><input type="checkbox" id="shareLocConsent"/></div>
      <button class="primary" onclick="saveDriverProfile()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
    </div>

    <div id="customerView" class="hidden">
      <h3>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
      <div id="offersList"></div>
    </div>
  </div>

  <div class="card">
    <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­ÙŠØ©</h3>
    <div id="map"></div>
    <hr/>
    <h3>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h3>
    <div id="chatBox" class="chat"></div>
    <div class="row">
      <input id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."/>
      <button class="primary" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<div class="modal hidden" id="loginModal">
  <div class="window">
    <h3 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="loginPhone" placeholder="+9627XXXXXXXX"/></div>
    <div id="recaptcha-container"></div>
    <button class="primary" onclick="sendOTP()">Ø¥Ø±Ø³Ø§Ù„ OTP</button>
    <div class="input"><label>Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</label><input id="loginCode"/></div>
    <button class="primary" onclick="verifyOTP()">ØªØ£ÙƒÙŠØ¯</button>
    <button class="ghost" onclick="closeLogin()">Ø¥Ù„ØºØ§Ø¡</button>
    <p id="loginStatus" class="muted"></p>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// ---------------- FIREBASE CONFIG ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDQtw1wHvarCO9WS3E-HVafkBWEkimnWfI",       // Replace if needed
  authDomain: "tawsilati-f175e.firebaseapp.com",
  projectId: "tawsilati-f175e",
  storageBucket: "tawsilati-f175e.appspot.com",
  messagingSenderId: "181685598480",
  appId: "1:181685598480:web:3f712bf3252b6660dccd95"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ---------------- APP STATE ----------------
let currentUser = null;
let confirmationResult = null;

// ---------------- LOGIN WITH PHONE ----------------
window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
  'size': 'normal',
  'callback': (response) => {
    console.log("reCAPTCHA verified");
  },
  'expired-callback': () => {
    console.log("reCAPTCHA expired");
  }
});

function openLogin(role){
  document.getElementById("loginModal").classList.remove("hidden");
  document.getElementById("loginTitle").innerText = role==="driver"?"Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚":"Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†";
}

function closeLogin(){
  document.getElementById("loginModal").classList.add("hidden");
}

function sendOTP(){
  const phone = document.getElementById("loginPhone").value;
  if(!phone){ alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"); return; }

  auth.signInWithPhoneNumber(phone, window.recaptchaVerifier)
    .then(res=>{
      confirmationResult = res;
      document.getElementById("loginStatus").innerText="OTP ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
    }).catch(err=>{
      console.error(err);
      document.getElementById("loginStatus").innerText="Ø­Ø¯Ø« Ø®Ø·Ø£: "+err.message;
    });
}

function verifyOTP(){
  const code = document.getElementById("loginCode").value;
  if(!code || !confirmationResult){ alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²"); return; }

  confirmationResult.confirm(code)
    .then(result=>{
      currentUser = result.user;
      document.getElementById("loginStatus").innerText="ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!";
      document.getElementById("loginModal").classList.add("hidden");
      console.log("Logged in UID:", currentUser.uid);
    }).catch(err=>{
      document.getElementById("loginStatus").innerText="Ø®Ø·Ø£: "+err.message;
    });
}

// ---------------- DRIVER PROFILE ----------------
function saveDriverProfile(){
  if(!currentUser) { alert("Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const name = document.getElementById("drvName").value;
  const phone = document.getElementById("drvPhone").value;
  const age = document.getElementById("drvAge").value;
  db.collection("drivers").doc(currentUser.uid).set({name,phone,age,timestamp:firebase.firestore.FieldValue.serverTimestamp()})
    .then(()=> alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù"))
    .catch(e=> alert("Ø®Ø·Ø£: "+e.message));
}

// ---------------- OFFERS ----------------
async function renderOffers(){
  const offersList = document.getElementById("offersList");
  offersList.innerHTML="";
  const snapshot = await db.collection("offers").orderBy("timestamp","desc").get();
  snapshot.forEach(doc=>{
    const o = doc.data();
    offersList.innerHTML += `<div class="offer">
      <strong>${o.from} â†’ ${o.to}</strong> <span class="badge">${o.price} Ø¯.Ø£</span>
    </div>`;
  });
}

// ---------------- CHAT ----------------
async function sendChat(){
  if(!currentUser) return alert("Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
  const msg = document.getElementById("chatInput").value;
  if(!msg) return;
  await db.collection("chat").add({
    uid:currentUser.uid,
    msg,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("chatInput").value="";
}

db.collection("chat").orderBy("timestamp").onSnapshot(snapshot=>{
  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML="";
  snapshot.forEach(doc=>{
    const c = doc.data();
    chatBox.innerHTML += `<div class="chat-msg"><b>${c.uid}</b>: ${c.msg}</div>`;
  });
});

</script>
</body>
</html>
