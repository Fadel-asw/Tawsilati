<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--emerald:#2ecc71;--midnight:#2c3e50;--bg:#ecf0f1;--accent:#e67e22;}
    body{margin:0;font-family:"Inter",sans-serif;background:var(--bg);direction:rtl}
    .header{background:var(--midnight);color:#fff;padding:12px;display:flex;justify-content:space-between}
    .brand{font-weight:bold}
    .btn{border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--emerald);color:#fff}
    .container{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 300px;gap:16px}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .input{margin-bottom:10px;display:flex;flex-direction:column}
    .chat{border:1px solid #ddd;border-radius:8px;padding:8px;max-height:200px;overflow:auto}
    #map{height:220px;border-radius:12px}
    .login-hero{display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#2ecc71,#2c3e50)}
    .login-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .muted{color:#6b7280;font-size:14px}
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="login-hero">
  <div class="login-card">
    <h2>ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</h2>
    <p class="muted">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± SMS</p>
    <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="loginName"/></div>
    <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="loginPhone" placeholder="+9627XXXXXXXX"/></div>
    <div class="input"><label><input type="checkbox" id="loginConsent"/> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</label></div>
    <div id="recaptcha-container"></div>
    <div class="input"><label>Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</label><input id="loginCode"/></div>
    <button class="btn primary" onclick="sendVerification()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø²</button>
    <button class="btn primary" onclick="completeLogin()">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <p id="loginStatus" class="muted"></p>
  </div>
</div>

<!-- MAIN APP -->
<div id="homePage" style="display:none">
  <header class="header">
    <div class="brand">ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</div>
    <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
  </header>
  <main class="container grid">
    <div class="card">
      <h2>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚</h2>
      <div id="offersList"></div>
      <hr/>
      <h2>Ø­Ø¬Ø² Ù…Ù‚Ø§Ø¹Ø¯ (Ø­Ø¬Ø¨ Ø±Ø­Ù„Ø©)</h2>
      <div id="blocksList"></div>
      <hr/>
      <h3>Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h3>
      <div id="chatBox" class="chat"></div>
      <div class="row">
        <input id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."/>
        <button class="btn primary" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
    <div class="card">
      <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
      <div id="map"></div>
    </div>
  </main>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDQtw1wHvarCO9WS3E-HVafkBWEkimnWfI",
    authDomain: "tawsilati-f175e.firebaseapp.com",
    projectId: "tawsilati-f175e",
    storageBucket: "tawsilati-f175e.firebasestorage.app",
    messagingSenderId: "181685598480",
    appId: "1:181685598480:web:3f712bf3252b6660dccd95",
    measurementId: "G-FVY6YCKREP"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();
  const $=id=>document.getElementById(id);

  let recaptchaVerifier, userMarker, map, selectedThreadId=null;

  // Login flow
  window.onload=()=>{
    recaptchaVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'invisible'});
    recaptchaVerifier.render();
  };
  function sendVerification(){
    const phone=$("loginPhone").value.trim();
    auth.signInWithPhoneNumber(phone,recaptchaVerifier)
      .then(cr=>{window.confirmationResult=cr;$("loginStatus").textContent="Ø±Ù…Ø² Ø£ÙØ±Ø³Ù„";})
      .catch(err=>{$("loginStatus").textContent="Ø®Ø·Ø£: "+err.message;});
  }
  function completeLogin(){
    const code=$("loginCode").value.trim();
    window.confirmationResult.confirm(code).then(res=>{
      localStorage.setItem("currentUser",JSON.stringify({uid:res.user.uid,name:$("loginName").value,phone:res.user.phoneNumber}));
      $("loginPage").style.display="none";$("homePage").style.display="block";
      initMap();subscribeOffers();subscribeBlocks();
    }).catch(()=>{$("loginStatus").textContent="Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­";});
  }
  $("btnLogout").onclick=()=>{auth.signOut();localStorage.removeItem("currentUser");location.reload();};

  // Map
  function initMap(){
    map=L.map("map").setView([31.95,35.91],12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    if(navigator.geolocation){
      navigator.geolocation.watchPosition(pos=>{
        const {latitude,longitude}=pos.coords;
        if(userMarker) userMarker.setLatLng([latitude,longitude]);
        else userMarker=L.marker([latitude,longitude]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ");
      });
    }
  }

  // Offers (general)
  function subscribeOffers(){
    db.collection("offers_general").onSnapshot(snap=>{
      let html="";snap.forEach(doc=>{const o=doc.data();
        html+=`<div class="offer"><strong>${o.driverProfile?.name||"-"}</strong> ${o.from}â†’${o.to} Ø§Ù„Ø³Ø¹Ø±:${o.price}Ø¯</div>`;
      });$("offersList").innerHTML=html||"<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶</p>";
    });
  }

  // Blocks (seat-based)
  function subscribeBlocks(){
    db.collection("blocks").onSnapshot(snap=>{
      let html="";snap.forEach(doc=>{const b=doc.data();
        html+=`<div class="offer"><strong>${b.driverProfile?.name||"-"}</strong> ${b.from}â†’${b.to} Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯:${b.seatsLeft}</div>`;
      });$("blocksList").innerHTML=html||"<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p>";
    });
  }

  // Chat
  function sendChat(){
    const msg=$("chatInput").value.trim();if(!msg||!selectedThreadId)return;
    const cu=JSON.parse(localStorage.getItem("currentUser")||"{}");
    db.collection("chats").doc(selectedThreadId).collection("messages").add({name:cu.name||"Ù…Ø³ØªØ®Ø¯Ù…",msg,ts:firebase.firestore.FieldValue.serverTimestamp()});
    $("chatInput").value="";
  }
</script>
</body>
</html>
