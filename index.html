<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
/* ---------- STYLES (keep as before) ---------- */
:root{
  --green:#12b886;
  --green-dark:#0f9a72;
  --bg-grad-1:#eafaf1;
  --bg-grad-2:#d7f2e4;
  --text:#122;
  --muted:#5b6b6b;
  --card:#ffffffcc;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg,var(--bg-grad-1), var(--bg-grad-2));
  color:var(--text);
  direction:rtl;
  display:flex;
  flex-direction:column;
}
header{
  background:var(--green);
  color:#fff;
  padding:16px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.brand{display:flex; align-items:center; gap:10px; font-weight:bold; font-size:20px;}
.header-actions{display:flex; gap:8px}
header button{border:none; background:#fff; color:var(--green); border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600;}
header button:hover{background:#f3fef8}
.main{display:grid; grid-template-columns: 360px 1fr; gap:16px; padding:16px; flex:1;}
@media (max-width: 960px){.main{grid-template-columns: 1fr}}
.card{background:var(--card); backdrop-filter:blur(10px); border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,0.08); padding:16px; transition:transform .25s ease, opacity .25s ease;}
.card h3{margin:0 0 10px 0}
.muted{color:var(--muted); font-size:14px}
button.primary{width:100%; padding:12px; border:none; border-radius:10px; background:var(--green); color:#fff; font-size:16px; cursor:pointer; transition:transform .2s ease, background .2s ease;}
button.primary:hover{background:var(--green-dark); transform:scale(1.02)}
button.ghost{width:100%; padding:12px; border:2px solid var(--green); border-radius:10px; color:var(--green); background:transparent; cursor:pointer;}
.input{display:flex; flex-direction:column; gap:6px; margin-bottom:10px;}
.input label{font-size:14px; color:#244}
.input input, .input select, .input textarea{padding:10px; border:1px solid #cfd8d8; border-radius:10px; font-size:15px; background:#fff;}
.row{display:flex; gap:10px}
.row > *{flex:1}
#map{width:100%; height:100%; min-height:420px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,0.08);}
.modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.25); z-index:1000; padding:16px;}
.modal .window{max-width:720px; width:100%; background:var(--card); backdrop-filter:blur(12px); border-radius:16px; padding:22px; box-shadow:0 10px 28px rgba(0,0,0,0.15); animation:pop .25s ease;}
@keyframes pop{from{transform:scale(.98); opacity:0} to{transform:scale(1); opacity:1}}
.actions{display:flex; gap:10px; margin-top:12px}
.offer{border:1px solid #e5efef; border-radius:12px; padding:12px; margin-bottom:10px; background:#fff;}
.offer-header{display:flex; justify-content:space-between; align-items:center}
.badge{background:#effaf5; color:var(--green-dark); padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
.tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
.tag{background:#f2fbf7; color:#285; padding:4px 8px; border-radius:999px; font-size:12px}
.offer-actions{display:flex; gap:8px; margin-top:10px}
button.sm{padding:8px 10px; border:none; border-radius:8px; cursor:pointer}
button.accept{background:var(--green); color:#fff}
button.reject{background:#f44336; color:#fff}
.chat{border:1px solid #e5efef; border-radius:12px; padding:10px; background:#fff; max-height:220px; overflow:auto}
.chat-msg{margin-bottom:8px}
.chat-meta{font-size:12px; color:#666}
.hidden{display:none}
.success{color:#1b8a5a}
.error{color:#c62828}
.preview{display:flex; gap:8px; flex-wrap:wrap}
.preview img{width:84px; height:84px; object-fit:cover; border-radius:10px; border:1px solid #e5efef}
</style>
</head>
<body>

<header>
  <div class="brand">ğŸš— ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</div>
  <div class="header-actions">
    <button id="btnRoleCustomer" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
    <button id="btnRoleDriver" class="hidden">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
    <button id="btnLogout" class="hidden">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<div class="main">
  <div class="card" id="panelControls">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <p class="muted">Ø§Ø®ØªØ± Ø¯ÙˆØ±ÙƒØŒ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ ÙˆØ§Ù†Ø´Ø± Ø£Ùˆ Ø§Ø­Ø¬Ø² Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
    <div id="roleSelect" class="actions">
      <button class="primary" onclick="openLogin('customer')">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†</button>
      <button class="ghost" onclick="openLogin('driver')">Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚</button>
    </div>
    <div id="driverSetup" class="hidden">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>
      <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="drvName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯"/></div>
      <div class="row">
        <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø£Ø±Ø¯Ù†)</label><input id="drvPhone" placeholder="+9627XXXXXXXX"/></div>
        <div class="input"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="drvAge" type="number" min="18" placeholder="Ø§Ù„Ø¹Ù…Ø±"/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ù„Ø¬Ù†Ø³</label><select id="drvGender"><option>Ø°ÙƒØ±</option><option>Ø£Ù†Ø«Ù‰</option></select></div>
        <div class="input"><label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label><input id="drvRating" type="number" step="0.1" min="0" max="5" placeholder="4.8"/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©"/></div>
        <div class="input"><label>Ù„ÙˆÙ† Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carColor" placeholder="Ø£Ø¨ÙŠØ¶ØŒ Ø£Ø³ÙˆØ¯..."/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carBrand" placeholder="ØªÙˆÙŠÙˆØªØ§ØŒ Ù‡ÙˆÙ†Ø¯Ø§..."/></div>
        <div class="input"><label>Ù†ÙˆØ¹/Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input id="carModel" placeholder="ÙƒÙˆØ±ÙˆÙ„Ø§ØŒ Ø³ÙŠÙÙŠÙƒ..."/></div>
      </div>
      <div class="input">
        <label>ØµÙˆØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <input id="carPhotos" type="file" multiple accept="image/*"/>
        <div id="photoPreview" class="preview"></div>
      </div>
      <div class="input">
        <label><input type="checkbox" id="shareLocConsent"/> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</label>
      </div>
      <button class="primary" onclick="saveDriverProfile()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù</button>
      <p id="drvSaveStatus" class="muted"></p>
      <hr/>
      <h3>Ù†Ø´Ø± Ø¹Ø±Ø¶ Ø±Ø­Ù„Ø©</h3>
      <div class="row">
        <div class="input"><label>Ù…Ù†</label><select id="fromRegion"></select></div>
        <div class="input"><label>Ø¥Ù„Ù‰</label><select id="toRegion"></select></div>
      </div>
      <div class="row">
        <div class="input"><label>Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙŠÙ†Ø§Ø±)</label><input id="offerPrice" type="number" min="0" step="0.5"/></div>
        <div class="input"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯</label><input id="offerSeats" type="number" min="1"/></div>
      </div>
      <div class="row">
        <div class="input"><label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label><input id="offerTime" type="datetime-local"/></div>
        <div class="input"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="offerNotes" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"/></div>
      </div>
      <button class="primary" onclick="publishOffer()">Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶</button>
      <p id="offerStatus" class="muted"></p>
      <hr/>
      <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h3>
      <div id="driverRequests"></div>
    </div>
    <div id="customerView" class="hidden">
      <h3>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
      <div class="row">
        <div class="input"><label>Ù…Ù†</label><select id="filterFrom"></select></div>
        <div class="input"><label>Ø¥Ù„Ù‰</label><select id="filterTo"></select></div>
      </div>
      <button class="primary" onclick="applyFilters()">ØªØµÙÙŠØ©</button>
      <button class="ghost" onclick="clearFilters()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØµÙÙŠØ©</button>
      <div id="offersList" style="margin-top:10px;"></div>
      <hr/>
      <h3>Ø­Ø¬Ø² Ù„Ø§Ø­Ù‚ (Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¯Ø¯)</h3>
      <div class="row">
        <div class="input"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label><input id="lateSeats" type="number" min="1" value="1"/></div>
        <div class="input"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="lateNote" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù‚ÙŠØ¨Ø© ÙƒØ¨ÙŠØ±Ø©"/></div>
      </div>
      <p class="muted">Ø§Ø®ØªØ± Ø¹Ø±Ø¶Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· "Ø­Ø¬Ø²" Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ.</p>
    </div>
  </div>
  <div class="card">
    <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­ÙŠØ©</h3>
    <p class="muted">ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…ÙˆØ§Ù‚Ø¹Ùƒ ÙˆÙ…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª. ÙŠØ³Ù…Ø­ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ø¨Ø¹Ø¯ Ù…Ù† Ù¦ ÙƒÙ….</p>
    <div id="map"></div>
    <hr/>
    <h3>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h3>
    <div id="chatBox" class="chat"></div>
    <div class="row">
      <input id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©..."/>
      <button class="primary" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<div class="modal hidden" id="loginModal">
  <div class="window">
    <h3 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <div class="row">
      <div class="input"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="loginName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ"/></div>
      <div class="input"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ø£Ø±Ø¯Ù†)</label><input id="loginPhone" placeholder="+9627XXXXXXXX"/></div>
    </div>
    <div class="input"><label><input type="checkbox" id="loginConsent"/> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</label></div>
    <div class="row">
      <button class="primary" onclick="sendVerification()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</button>
      <div class="input" style="flex:2"><label>Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</label><input id="loginCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²"/></div>
    </div>
    <div class="actions">
      <button class="primary" onclick="completeLogin()">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="ghost" onclick="closeLogin()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <p id="loginStatus" class="muted"></p>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// ---------- FIREBASE CONFIG ----------
const firebaseConfig = {
  apiKey: "AIzaSyDQtw1wHvarCO9WS3E-HVafkBWEkimnWfI",
  authDomain: "tawsilati-f175e.firebaseapp.com",
  projectId: "tawsilati-f175e",
  storageBucket: "tawsilati-f175e.appspot.com",
  messagingSenderId: "181685598480",
  appId: "1:181685598480:web:3f712bf3252b6660dccd95",
  measurementId: "G-FVY6YCKREP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ---------- APP STATE ----------
let currentUser = null;
let currentRole = null;

// ---------- LOGIN / OTP ----------
function openLogin(role){
  currentRole = role;
  document.getElementById("loginModal").classList.remove("hidden");
  document.getElementById("loginTitle").innerText = role==="driver"?"Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚":"Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø¨ÙˆÙ†";
}

function closeLogin(){
  document.getElementById("loginModal").classList.add("hidden");
}

let confirmationResult = null;

function sendVerification(){
  const phone = document.getElementById("loginPhone").value;
  if(!phone){ alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"); return; }
  // Use Firebase test numbers (will not actually send SMS in dev)
  auth.signInWithPhoneNumber(phone, window.recaptchaVerifier || {
    confirm: (code)=>{ console.log("test") }
  }).then((result)=>{
    confirmationResult = result;
    document.getElementById("loginStatus").innerText="ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚";
  }).catch(e=>{
    console.error(e); document.getElementById("loginStatus").innerText="Ø­Ø¯Ø« Ø®Ø·Ø£: "+e.message;
  });
}

function completeLogin(){
  const code = document.getElementById("loginCode").value;
  if(!code || !confirmationResult){ alert("Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚"); return; }
  confirmationResult.confirm(code).then((result)=>{
    currentUser = result.user;
    document.getElementById("loginStatus").innerText="ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­";
    document.getElementById("loginModal").classList.add("hidden");
    showUIForRole();
  }).catch(e=>{ document.getElementById("loginStatus").innerText="Ø®Ø·Ø£: "+e.message });
}

// ---------- UI ----------
function showUIForRole(){
  document.getElementById("roleSelect").classList.add("hidden");
  if(currentRole==="driver"){
    document.getElementById("driverSetup").classList.remove("hidden");
  } else {
    document.getElementById("customerView").classList.remove("hidden");
  }
}

// ---------- FIRESTORE OFFERS ----------
async function publishOffer(){
  const from = document.getElementById("fromRegion").value;
  const to = document.getElementById("toRegion").value;
  const price = document.getElementById("offerPrice").value;
  const seats = document.getElementById("offerSeats").value;
  const time = document.getElementById("offerTime").value;
  const notes = document.getElementById("offerNotes").value;
  if(!from || !to || !price || !seats){ alert("Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

  await db.collection("offers").add({
    driver: currentUser.uid,
    from,to,price,seats,time,notes,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("offerStatus").innerText="ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶!";
  renderOffers();
}

async function renderOffers(){
  const offersList = document.getElementById("offersList");
  offersList.innerHTML="";
  const snapshot = await db.collection("offers").orderBy("timestamp","desc").get();
  snapshot.forEach(doc=>{
    const o = doc.data();
    offersList.innerHTML += `<div class="offer">
      <div class="offer-header"><strong>${o.from} â†’ ${o.to}</strong> <span class="badge">${o.price} Ø¯.Ø£</span></div>
      <div>Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯: ${o.seats}</div>
      <div>Ù…ÙˆØ¹Ø¯: ${o.time || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>
      <div>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.notes || "-"}</div>
     
