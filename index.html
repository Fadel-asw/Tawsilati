<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ØªÙˆØµÙŠÙ„Ø§ØªÙŠ | Tawsilati</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
:root {
  /* Modern Palette */
  --primary: #6C63FF; /* Modern Purple */
  --primary-dark: #5a52d5;
  --primary-light: #e0dfff;
  --accent: #00D2D3; /* Teal for actions */
  --dark: #2d3436;
  --text: #2d3436;
  --text-light: #636e72;
  --bg: #f8f9fa;
  --surface: #ffffff;
  --danger: #ff7675;
  --success: #00b894;
  --border: #dfe6e9;
  --shadow: 0 4px 20px rgba(0,0,0,0.06);
  --radius: 16px;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

html, body { height: 100%; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

/* --- Utility Classes --- */
.hidden { display: none !important; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.justify-center { justify-content: center; }
.gap-2 { gap: 0.5rem; }
.gap-4 { gap: 1rem; }
.w-full { width: 100%; }
.text-sm { font-size: 0.875rem; }
.text-xs { font-size: 0.75rem; }
.text-muted { color: var(--text-light); }
.text-center { text-align: center; }
.font-bold { font-weight: 700; }

/* --- Buttons --- */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer;
  font-family: inherit; font-weight: 700; transition: all 0.2s ease;
  font-size: 1rem; width: 100%;
}
.btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(108, 99, 255, 0.3); }
.btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
.btn-secondary { background: white; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: #f1f2f6; }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
.btn-outline:hover { background: var(--primary-light); }
.btn-sm { padding: 8px 14px; font-size: 0.85rem; width: auto; }
.btn-danger { background: var(--danger); color: white; }

/* --- Inputs --- */
.input-group { margin-bottom: 1rem; text-align: right; }
.input-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--text); font-size: 0.9rem; }
.input-field {
  width: 100%; padding: 12px 16px; border: 2px solid var(--border);
  border-radius: 12px; font-size: 1rem; background: var(--surface);
  transition: border-color 0.2s; font-family: inherit;
}
.input-field:focus { border-color: var(--primary); }

/* --- Views Container --- */
#app { height: 100vh; display: flex; flex-direction: column; }

/* --- Login View --- */
#view-login {
  flex: 1; display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  padding: 20px; overflow-y: auto;
}
.login-card {
  background: white; width: 100%; max-width: 420px;
  padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  text-align: center; animation: slideUp 0.4s ease-out;
}
.role-selector { display: flex; gap: 10px; margin: 20px 0; }
.role-btn { flex: 1; padding: 15px; border: 2px solid var(--border); border-radius: 16px; cursor: pointer; transition: all 0.2s; }
.role-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }
.role-btn:hover:not(.active) { border-color: var(--primary); }

/* --- Dashboard View --- */
#view-dashboard { height: 100%; display: flex; flex-direction: column; }
header {
  height: 70px; background: white; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
  flex-shrink: 0; z-index: 100;
}
.logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }

/* Layout Grid */
.dashboard-content {
  flex: 1; display: flex; overflow: hidden; position: relative;
}
.sidebar {
  width: 450px; background: var(--bg); border-left: 1px solid var(--border);
  display: flex; flex-direction: column; z-index: 10;
  overflow-y: auto; padding: 20px; scroll-behavior: smooth;
}
.map-wrapper {
  flex: 1; position: relative; background: #e9ecef;
}
#map { width: 100%; height: 100%; }

/* Tabs */
.tabs { display: flex; background: white; padding: 6px; border-radius: 14px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.tab { flex: 1; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: 600; color: var(--text-light); transition: all 0.2s; }
.tab.active { background: var(--primary); color: white; shadow: 0 2px 5px rgba(108, 99, 255, 0.2); }

/* Cards */
.card {
  background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.02); border: 1px solid var(--border);
}
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.trip-card { position: relative; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
.trip-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: var(--primary); }

.badge {
  padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
}
.badge-success { background: #e6fffa; color: var(--success); }
.badge-warning { background: #fff7e6; color: #ffa502; }
.badge-info { background: #e7f5ff; color: var(--primary); }

/* Chat */
.chat-panel {
  position: absolute; bottom: 20px; left: 20px; width: 320px; max-height: 400px;
  background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  display: flex; flex-direction: column; overflow: hidden; z-index: 500;
}
.chat-header { background: var(--primary); color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
.chat-messages { flex: 1; padding: 12px; overflow-y: auto; background: #fdfdfd; min-height: 150px; }
.chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
.chat-msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; line-height: 1.4; }
.chat-msg.me { background: var(--primary-light); margin-right: auto; border-bottom-right-radius: 2px; }
.chat-msg.them { background: #f1f2f6; margin-left: auto; border-bottom-left-radius: 2px; }

/* Animations */
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* Mobile Responsive */
@media (max-width: 900px) {
  .dashboard-content { flex-direction: column-reverse; }
  .sidebar { width: 100%; height: 55%; }
  .map-wrapper { height: 45%; }
  .chat-panel { width: 90%; left: 5%; bottom: 10px; }
}

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000;
  display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);
}
.modal-content {
  background: white; width: 90%; max-width: 500px; padding: 24px; border-radius: 20px;
  animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto;
}
</style>
</head>
<body>

<div id="app">
  
  <!-- === VIEW 1: LOGIN === -->
  <div id="view-login">
    <div class="login-card">
      <div style="font-size: 3rem; margin-bottom: 10px;">ğŸš—</div>
      <h1 style="margin: 0; color: var(--primary);">ØªÙˆØµÙŠÙ„Ø§ØªÙŠ</h1>
      <p class="text-muted" style="margin-bottom: 24px;">Ù…Ù†ØµØ© Ø§Ù„Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØ§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙÙŠ Ø§Ù„Ø£Ø±Ø¯Ù†</p>
      
      <div class="role-selector">
        <div class="role-btn active" id="roleBtnCustomer" onclick="selectLoginRole('customer')">
          <div style="font-size:1.5rem">ğŸ‘¤</div>
          <div>Ø²Ø¨ÙˆÙ†</div>
        </div>
        <div class="role-btn" id="roleBtnDriver" onclick="selectLoginRole('driver')">
          <div style="font-size:1.5rem">ğŸš•</div>
          <div>Ø³Ø§Ø¦Ù‚</div>
        </div>
      </div>

      <div id="loginForm">
        <div class="input-group">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="loginName" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
        </div>
        <div class="input-group">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="loginPhone" class="input-field" placeholder="079 XXXXXXX" type="tel">
        </div>
        <div class="input-group" style="text-align: right; font-size: 0.9rem;">
          <label style="display:inline; font-weight:normal; cursor:pointer;">
            <input type="checkbox" id="loginConsent"> Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
          </label>
        </div>
        
        <!-- Recaptcha placeholder -->
        <div id="recaptcha-container" style="margin-bottom: 1rem; display: flex; justify-content: center;"></div>

        <div id="codeInputArea" class="hidden">
          <div class="input-group">
            <label>Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (SMS)</label>
            <input id="loginCode" class="input-field" placeholder="XXXXXX">
          </div>
        </div>

        <button id="btnAction" class="btn btn-primary" onclick="handleLoginAction()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</button>
        <p id="loginStatus" class="text-sm" style="margin-top:10px; min-height: 20px;"></p>
      </div>
    </div>
  </div>

  <!-- === VIEW 2: DASHBOARD === -->
  <div id="view-dashboard" class="hidden">
    <header>
      <div class="logo">
        <span>ğŸš—</span> ØªÙˆØµÙŠÙ„Ø§ØªÙŠ
      </div>
      <div class="flex items-center gap-4">
        <span id="userNameDisplay" class="font-bold text-muted"></span>
        <button class="btn btn-sm btn-secondary" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <div class="dashboard-content">
      <!-- Sidebar -->
      <div class="sidebar">
        
        <!-- CUSTOMER INTERFACE -->
        <div id="customerInterface" class="hidden">
          <div class="tabs">
            <div class="tab active" id="tabBook" onclick="switchCustomerTab('book')">Ø­Ø¬Ø² Ù…Ù‚Ø¹Ø¯</div>
            <div class="tab" id="tabBlock" onclick="switchCustomerTab('block')">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© (Block)</div>
          </div>

          <!-- Tab: Book a Seat -->
          <div id="contentBook">
            <div class="card">
              <h3 style="margin:0 0 10px;">ØªØµÙÙŠØ© Ø§Ù„Ø¹Ø±ÙˆØ¶</h3>
              <div class="flex gap-2">
                <select id="filterFrom" class="input-field"><option value="">Ø§Ù„ÙƒÙ„ (Ù…Ù†)</option></select>
                <select id="filterTo" class="input-field"><option value="">Ø§Ù„ÙƒÙ„ (Ø¥Ù„Ù‰)</option></select>
              </div>
              <button class="btn btn-secondary btn-sm" style="margin-top:10px;" onclick="applyFilters()">Ø¨Ø­Ø«</button>
            </div>
            <div id="offersList"></div>
          </div>

          <!-- Tab: Block a Trip -->
          <div id="contentBlock" class="hidden">
            <div class="card" style="border-color: var(--primary);">
              <h3 style="color: var(--primary);">Ø·Ù„Ø¨ Ø­Ø¬Ø² ÙƒØ§Ù…Ù„ (Block)</h3>
              <p class="text-muted text-sm">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¦Ø¬Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ø­Ø¯Ø¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ³ÙŠØµÙ„ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.</p>
              
              <div class="input-group">
                <label>Ù…Ù† Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="blockFrom" class="input-field"></select>
              </div>
              <div class="input-group">
                <label>Ø¥Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="blockTo" class="input-field"></select>
              </div>
              <div class="flex gap-2">
                <div class="input-group w-full">
                  <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø¯.Ø£)</label>
                  <input id="blockPrice" type="number" class="input-field" placeholder="0.00">
                </div>
                <div class="input-group w-full">
                  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©</label>
                  <input id="blockSeats" type="number" class="input-field" placeholder="4" min="1">
                </div>
              </div>
              <div class="input-group">
                <label>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
                <input id="blockTime" type="datetime-local" class="input-field">
              </div>
              <button class="btn btn-primary" onclick="publishBlockRequest()">Ù†Ø´Ø± Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø²</button>
            </div>
            
            <h3 style="margin: 20px 0 10px;">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
            <div id="myBlockRequests"></div>
          </div>
        </div>

        <!-- DRIVER INTERFACE -->
        <div id="driverInterface" class="hidden">
          <div class="card">
            <h3>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <div class="flex gap-2">
              <button class="btn btn-secondary btn-sm w-full" onclick="showDriverProfile()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
              <button class="btn btn-primary btn-sm w-full" onclick="showPublishForm()">+ Ù†Ø´Ø± Ø±Ø­Ù„Ø©</button>
            </div>
          </div>

          <div id="driverFormsArea" class="hidden">
            <!-- Publish Form -->
            <div id="formPublish" class="card hidden">
              <h3>Ù†Ø´Ø± Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
              <div class="flex gap-2">
                <select id="pubFrom" class="input-field"><option value="">Ù…Ù†</option></select>
                <select id="pubTo" class="input-field"><option value="">Ø¥Ù„Ù‰</option></select>
              </div>
              <div class="flex gap-2" style="margin-top:10px">
                <input id="pubPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="input-field">
                <input id="pubSeats" type="number" placeholder="Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯" class="input-field">
              </div>
              <input id="pubTime" type="datetime-local" class="input-field" style="margin-top:10px">
              <button class="btn btn-primary" style="margin-top:10px" onclick="publishOffer()">Ù†Ø´Ø±</button>
              <button class="btn btn-secondary btn-sm" style="margin-top:10px" onclick="closeDriverForms()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>

            <!-- Profile Form -->
            <div id="formProfile" class="card hidden">
              <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h3>
              <div class="input-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label><input id="profPlate" class="input-field"></div>
              <div class="input-group"><label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><input id="profCar" class="input-field" placeholder="ØªÙˆÙŠÙˆØªØ§ ÙƒØ§Ù…Ø±ÙŠ"></div>
              <div class="input-group"><label>Ø§Ù„Ù„ÙˆÙ†</label><input id="profColor" class="input-field"></div>
              <div class="input-group"><label>ØµÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="file" id="profPhotos" multiple class="input-field"></div>
              <button class="btn btn-primary" style="margin-top:10px" onclick="saveDriverProfile()">Ø­ÙØ¸</button>
              <button class="btn btn-secondary btn-sm" style="margin-top:10px" onclick="closeDriverForms()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>

          <h3 style="margin: 20px 0 10px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
          <div id="driverRequestsList"></div>
        </div>

      </div> <!-- End Sidebar -->

      <!-- Map Area -->
      <div class="map-wrapper">
        <div id="map"></div>
        
        <!-- Floating Toggle for Map on Mobile if needed, but keeping simple for now -->
      </div>

      <!-- Chat Widget -->
      <div id="chatWidget" class="chat-panel hidden">
        <div class="chat-header">
          <span id="chatTitle">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span>
          <span style="cursor:pointer" onclick="toggleChat()">âœ•</span>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-area">
          <input id="chatInput" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="padding:8px">
          <button class="btn btn-primary btn-sm" onclick="sendChat()">â¤</button>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- JS Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage-compat.js"></script>

<script>
// === CONFIGURATION ===
const firebaseConfig = {
  apiKey: "AIzaSyDQtw1wHvarCO9WS3E-HVafkBWEkimnWfI",
  authDomain: "tawsilati-f175e.firebaseapp.com",
  projectId: "tawsilati-f175e",
  storageBucket: "tawsilati-f175e.firebasestorage.app",
  messagingSenderId: "181685598480",
  appId: "1:181685598480:web:3f712bf3252b6660dccd95",
  measurementId: "G-FVY6YCKREP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// === STATE & DATA ===
const REGIONS = ["Ø§Ø±Ø¨Ø¯Ù‘","Ø§Ù„ÙƒÙˆØ±Ø©","Ø§Ù„Ø­ÙŠ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ","Ø§Ù„Ø­ÙŠ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠ","ÙƒÙØ± ÙŠÙˆØ¨Ø§","Ø§Ù„Ø·ÙŠØ¨Ø©","Ø¹Ù…Ø§Ù†","Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡","Ø§Ù„Ø¹Ù‚Ø¨Ø©","Ø§Ù„Ù…ÙØ±Ù‚","Ø¬Ø±Ø´","Ø¹Ø¬Ù„ÙˆÙ†","Ø§Ù„Ø³Ù„Ø·","Ù…Ø§Ø¯Ø¨Ø§","Ø§Ù„ÙƒØ±Ùƒ","Ù…Ø¹Ø§Ù†"];

let currentUser = null;
let currentRole = 'customer'; // 'customer' or 'driver'
let map, userMarker, watchId;
let selectedOfferId = null; // For chat context
let recaptchaVerifier = null;
let confirmationResult = null;

// === DOM ELEMENTS ===
const $ = id => document.getElementById(id);

// === INITIALIZATION ===
(function init(){
  populateSelects();
  // Check auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      // User logged in, check if we have role stored
      // In a real app, fetch role from Firestore. Here we assume local or prompt.
      // But since we forced role selection in new login flow:
      currentUser = user;
      $('userNameDisplay').textContent = user.displayName || user.phoneNumber;
      showDashboard();
    } else {
      showLogin();
    }
  });
})();

function populateSelects(){
  const ids = ['filterFrom','filterTo','blockFrom','blockTo','pubFrom','pubTo'];
  ids.forEach(id => {
    const el = $(id);
    if(!el) return;
    const currentVal = el.value;
    el.innerHTML = `<option value="">${id.includes('filter')?'Ø§Ù„ÙƒÙ„':'Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'}</option>`;
    REGIONS.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r; opt.textContent = r;
      el.appendChild(opt);
    });
    el.value = currentVal;
  });
}

// === MAP ===
function initMap() {
  if(map) return;
  map = L.map("map").setView([31.95, 35.91], 8);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);
  
  // Resize observer for the map wrapper to handle responsive resizing
  new ResizeObserver(() => map.invalidateSize()).observe($('map-wrapper'));
}

function startLocationTracking(){
  if(!navigator.geolocation) return;
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(pos => {
    const {latitude:lat, longitude:lng} = pos.coords;
    if(userMarker) userMarker.setLatLng([lat,lng]);
    else userMarker = L.marker([lat,lng], {icon: getIcon('user')}).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ");
    
    // Update user location in DB periodically could happen here
    // db.collection('users').doc(currentUser.uid).update({loc: new firebase.firestore.GeoPoint(lat, lng)});
  }, err => console.log(err), {enableHighAccuracy:true});
}

function getIcon(type){
  // Simple logic to return different markers if needed
  return new L.Icon.Default();
}

// === AUTH & NAVIGATION FLOW ===

function showLogin(){
  $('view-login').classList.remove('hidden');
  $('view-dashboard').classList.add('hidden');
  $('app').style.background = "linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)";
}

function showDashboard(){
  $('view-login').classList.add('hidden');
  $('view-dashboard').classList.remove('hidden');
  $('app').style.background = "var(--bg)";
  initMap();
  startLocationTracking();

  // Based on role selected during login (stored in variable for session)
  if(currentRole === 'driver'){
    $('customerInterface').classList.add('hidden');
    $('driverInterface').classList.remove('hidden');
    subscribeDriverRequests();
  } else {
    $('customerInterface').classList.remove('hidden');
    $('driverInterface').classList.add('hidden');
    subscribeOffers(); // Load offers
    loadMyBlockRequests();
  }
}

function selectLoginRole(role){
  currentRole = role;
  $('roleBtnCustomer').classList.toggle('active', role === 'customer');
  $('roleBtnDriver').classList.toggle('active', role === 'driver');
}

async function handleLoginAction(){
  const phone = $('loginPhone').value.trim();
  const name = $('loginName').value.trim();
  const status = $('loginStatus');
  const consent = $('loginConsent').checked;

  status.textContent = '';
  status.className = '';

  // Step 1: Send Code
  if (!confirmationResult) {
    if(!name || !phone) { status.textContent = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"; status.style.color="red"; return; }
    if(!consent) { status.textContent = "ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©"; status.style.color="red"; return; }

    if(!recaptchaVerifier){
       recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
       await recaptchaVerifier.render();
    }

    auth.signInWithPhoneNumber(phone, recaptchaVerifier)
      .then(result => {
        confirmationResult = result;
        $('codeInputArea').classList.remove('hidden');
        $('btnAction').textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        status.textContent = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²";
        status.style.color = "green";
      })
      .catch(err => {
        status.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + err.message;
        status.style.color = "red";
      });
  } 
  // Step 2: Verify Code
  else {
    const code = $('loginCode').value.trim();
    if(!code) return;

    confirmationResult.confirm(code)
      .then(result => {
        const user = result.user;
        // Update Profile
        await db.collection('users').doc(user.uid).set({
          name: name,
          phone: phone,
          role: currentRole,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge: true});
        
        showDashboard();
      })
      .catch(err => {
        status.textContent = "Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­";
        status.style.color = "red";
      });
  }
}

function logout(){
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")){
    auth.signOut();
    window.location.reload();
  }
}

// === CUSTOMER LOGIC ===

function switchCustomerTab(tab){
  $('tabBook').classList.toggle('active', tab === 'book');
  $('tabBlock').classList.toggle('active', tab === 'block');
  $('contentBook').classList.toggle('hidden', tab !== 'book');
  $('contentBlock').classList.toggle('hidden', tab !== 'block');
}

// 1. Booking (Standard)
let offersUnsub = null;
function subscribeOffers(){
  if(offersUnsub) offersUnsub();
  const list = $('offersList');
  const fFrom = $('filterFrom').value;
  const fTo = $('filterTo').value;

  // Only query if filters are set, otherwise show recent
  let q = db.collection('offers').orderBy('createdAt', 'desc').limit(20);
  
  offersUnsub = q.onSnapshot(snap => {
    let html = '';
    snap.forEach(doc => {
      const d = doc.data();
      d.id = doc.id;
      
      if(fFrom && d.from !== fFrom) return;
      if(fTo && d.to !== fTo) return;

      // Driver info
      const drvName = d.driverProfile?.name || "Ø³Ø§Ø¦Ù‚";
      const carInfo = d.driverProfile?.carModel ? d.driverProfile.carModel + " " + (d.driverProfile?.carColor||"") : "Ø³ÙŠØ§Ø±Ø©";
      
      html += `
        <div class="card trip-card">
          <div class="card-header">
            <div>
              <div class="font-bold">${d.from} <span style="color:var(--text-light)">â†</span> ${d.to}</div>
              <div class="text-xs text-muted">${carInfo}</div>
            </div>
            <div class="font-bold text-primary">${d.price} Ø¯.Ø£</div>
          </div>
          <div class="flex justify-between items-center text-sm text-muted">
             <span>ğŸ•’ ${new Date(d.time).toLocaleTimeString('ar-JO', {hour:'2-digit', minute:'2-digit'})}</span>
             <span>ğŸ’º ${d.seatsLeft} Ù…Ù‚Ø¹Ø¯</span>
             <span>â­ ${d.driverProfile?.rating || '5.0'}</span>
          </div>
          <div class="flex gap-2" style="margin-top:15px">
             <button class="btn btn-sm btn-outline w-full" onclick="requestRide('${d.id}', ${d.seatsLeft}, false)">Ø­Ø¬Ø² Ù…Ù‚Ø¹Ø¯</button>
             <button class="btn btn-sm btn-secondary" onclick="focusMap(${d.lat}, ${d.lng})">ğŸ“</button>
          </div>
        </div>
      `;
    });
    list.innerHTML = html || '<div class="text-center text-muted" style="padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
  });
}

function applyFilters(){ subscribeOffers(); }

// 2. Blocking (Custom Request)
function publishBlockRequest(){
  const from = $('blockFrom').value;
  const to = $('blockTo').value;
  const price = $('blockPrice').value;
  const seats = $('blockSeats').value; // "Number of seats to be blocked" as requested
  const time = $('blockTime').value;

  if(!from || !to || !price || !seats || !time){
    alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return;
  }

  db.collection('block_requests').add({
    customerId: currentUser.uid,
    customerName: currentUser.displayName || $('loginName').value,
    customerPhone: currentUser.phoneNumber,
    from, to, price, seats, time,
    status: 'pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    alert("ØªÙ… Ù†Ø´Ø± Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­");
    $('blockPrice').value = '';
  });
}

function loadMyBlockRequests(){
  db.collection('block_requests').where('customerId', '==', currentUser.uid)
    .orderBy('createdAt', 'desc')
    .onSnapshot(snap => {
      const container = $('myBlockRequests');
      if(snap.empty){ container.innerHTML = '<p class="text-muted text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>'; return; }
      
      let html = '';
      snap.forEach(doc => {
        const d = doc.data();
        let badgeClass = d.status === 'accepted' ? 'badge-success' : (d.status === 'pending' ? 'badge-warning' : '');
        let statusText = d.status === 'accepted' ? 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„' : (d.status === 'pending' ? 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : d.status);
        
        html += `
          <div class="card" style="padding:15px;">
            <div class="flex justify-between">
               <strong>${d.from} â†’ ${d.to}</strong>
               <span class="badge ${badgeClass}">${statusText}</span>
            </div>
            <div class="text-sm text-muted">${d.seats} Ù…Ù‚Ø§Ø¹Ø¯ â€¢ ${d.price} Ø¯.Ø£</div>
          </div>
        `;
      });
      container.innerHTML = html;
    });
}

async function requestRide(offerId, seatsLeft, isBlock){
  if(!currentUser) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
  
  // Simple prompt for seats if standard booking
  let reqSeats = 1;
  let note = "";
  
  if(!isBlock){
    reqSeats = prompt("ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ØŸ", "1");
    if(!reqSeats) return;
    reqSeats = parseInt(reqSeats);
  }

  // Add request
  await db.collection('requests').add({
    offerId,
    customer: {
      uid: currentUser.uid,
      name: currentUser.displayName || "Ù…Ø³ØªØ®Ø¯Ù…",
      phone: currentUser.phoneNumber
    },
    seats: reqSeats,
    note: note,
    status: 'pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚.");
  
  // Auto open chat context
  openChat(offerId);
}

// === DRIVER LOGIC ===

function closeDriverForms(){
  $('driverFormsArea').classList.add('hidden');
}
function showPublishForm(){
  $('driverFormsArea').classList.remove('hidden');
  $('formPublish').classList.remove('hidden');
  $('formProfile').classList.add('hidden');
}
function showDriverProfile(){
  $('driverFormsArea').classList.remove('hidden');
  $('formProfile').classList.remove('hidden');
  $('formPublish').classList.add('hidden');
}

async function publishOffer(){
  const from = $('pubFrom').value;
  const to = $('pubTo').value;
  const price = parseFloat($('pubPrice').value);
  const seats = parseInt($('pubSeats').value);
  const time = $('pubTime').value;

  if(!from || !to || !price || !seats || !time){
    alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return;
  }

  // Get driver profile
  const profSnap = await db.collection('users').doc(currentUser.uid).get();
  const prof = profSnap.exists ? profSnap.data() : {};

  await db.collection('offers').add({
    driverId: currentUser.uid,
    from, to, price, seatsLeft: seats, time,
    driverProfile: prof, // contains car info if saved
    lat: 31.95, lng: 35.91, // Default to Amman for demo, should be real loc
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
  closeDriverForms();
}

async function saveDriverProfile(){
  const plate = $('profPlate').value;
  const car = $('profCar').value;
  const color = $('profColor').value;

  await db.collection('users').doc(currentUser.uid).update({
    plate, carModel: car, carColor: color
  });

  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  closeDriverForms();
}

function subscribeDriverRequests(){
  // Listen for normal ride requests on my offers
  // AND block requests nearby
  
  // 1. Normal Requests
  db.collection('requests').where('status', '==', 'pending')
    .onSnapshot(snap => {
      renderRequests(snap, 'driverRequestsList', 'normal');
    });
    
  // 2. Block Requests (Filtering by region would happen server-side usually, 
  // here we fetch all for demo and filter client side or just show all recent)
  db.collection('block_requests').where('status', '==', 'pending')
    .orderBy('createdAt', 'desc')
    .onSnapshot(snap => {
      renderRequests(snap, 'driverRequestsList', 'block');
    });
}

function renderRequests(snap, containerId, type){
  const container = $(containerId);
  // In a real app, clear container and rebuild mixed list. 
  // For simplicity, we just append new ones or rebuild completely based on combined data
  // Here is a simplified renderer assuming we call it separately.
  
  // NOTE: This is a simplified renderer. In production, merge two streams.
  if(type === 'normal'){
     // Logic for normal ride requests
     let html = '';
     snap.forEach(doc => {
       const r = doc.data();
       html += `
         <div class="card" style="padding:12px; border-right: 4px solid var(--primary)">
           <div class="font-bold">Ø·Ù„Ø¨ Ø­Ø¬Ø² (${r.seats} Ù…Ù‚Ø§Ø¹Ø¯)</div>
           <div class="text-sm text-muted">Ø§Ù„Ø²Ø¨ÙˆÙ†: ${r.customer.name}</div>
           <div class="flex gap-2" style="margin-top:8px">
             <button class="btn btn-sm btn-success" style="background:var(--success);color:white;border:none;border-radius:8px" onclick="acceptRequest('${doc.id}', '${r.offerId}')">Ù‚Ø¨ÙˆÙ„</button>
             <button class="btn btn-sm btn-danger" style="background:var(--danger);color:white;border:none;border-radius:8px" onclick="rejectRequest('${doc.id}')">Ø±ÙØ¶</button>
           </div>
         </div>
       `;
     });
     if(html) container.innerHTML = html + container.innerHTML; // Prepend
  } else if (type === 'block') {
     let html = '';
     snap.forEach(doc => {
       const r = doc.data();
       html += `
         <div class="card" style="padding:12px; border-right: 4px solid var(--accent)">
           <div class="font-bold text-primary">Ø·Ù„Ø¨ Ø­Ø¬Ø² ÙƒØ§Ù…Ù„ (Block)</div>
           <div>${r.from} â†’ ${r.to}</div>
           <div class="flex justify-between text-sm">
             <span>Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯: ${r.seats}</span>
             <span>Ø§Ù„Ø³Ø¹Ø±: ${r.price}</span>
           </div>
           <div class="flex gap-2" style="margin-top:8px">
             <button class="btn btn-sm" style="background:var(--accent);color:white;border:none;border-radius:8px" onclick="acceptBlock('${doc.id}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
           </div>
         </div>
       `;
     });
     if(html) container.innerHTML = html + container.innerHTML;
  }
}

async function acceptRequest(reqId, offerId){
  await db.collection('requests').doc(reqId).update({status: 'accepted'});
  await db.collection('offers').doc(offerId).update({
    seatsLeft: firebase.firestore.FieldValue.increment(-1) // Simplified decrement
  });
  openChat(offerId);
  // Re-render handled by snapshot listener ideally, here we remove manually for instant feedback
  event.target.closest('.card').remove();
}

function rejectRequest(reqId){
  db.collection('requests').doc(reqId).update({status: 'rejected'});
  event.target.closest('.card').remove();
}

// === CHAT ===
function openChat(offerId){
  selectedOfferId = offerId;
  $('chatWidget').classList.remove('hidden');
  $('chatTitle').textContent = "Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø­Ù„Ø©";
  
  db.collection('chats').doc(offerId).collection('messages')
    .orderBy('ts', 'asc')
    .onSnapshot(snap => {
      const box = $('chatMessages');
      box.innerHTML = '';
      snap.forEach(doc => {
        const m = doc.data();
        const isMe = m.senderId === currentUser.uid;
        const div = document.createElement('div');
        div.className = `chat-msg ${isMe ? 'me' : 'them'}`;
        div.textContent = m.text;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    });
}

function toggleChat(){
  $('chatWidget').classList.add('hidden');
}

function sendChat(){
  const txt = $('chatInput').value.trim();
  if(!txt || !selectedOfferId) return;
  
  db.collection('chats').doc(selectedOfferId).collection('messages').add({
    senderId: currentUser.uid,
    senderName: currentUser.displayName || "Ø£Ù†Ø§",
    text: txt,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  });
  
  $('chatInput').value = '';
}

function focusMap(lat, lng){
  map.setView([lat, lng], 12);
  L.popup().setLatLng([lat, lng]).setContent("Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø­Ù„Ø©").openOn(map);
}

</script>
</body>
</html>
